"use strict";(self.webpackChunktgstation_server_control_panel=self.webpackChunktgstation_server_control_panel||[]).push([[264],{2741:function(e,t,n){n.d(t,{Z:function(){return o}});var r=n(7294),a=n(5293),s=n(3489),i=n(4012);function o(e){return r.createElement(a.Z,{show:e.show,overlay:r.createElement(s.Z,{id:e.tooltipid},r.createElement(i.Z,{id:e.tooltipid}))},e.children)}},8264:function(e,t,n){n.r(t),n.d(t,{default:function(){return j}});var r,a,s=n(7294),i=n(5881),o=n(2086),l=n(5005),c=n(5293),m=n(3489),d=n(5147),p=n(7959),u=n(4012),h=n(5856),f=n(8509),g=n(3204),y=n(6846),E=n(3803),b=n(7611),S=n(7961),w=n(9521),v=n(6190),Z=n(7428),R=n(6964),C=n(3e3),P=n(9635),T=n(9049),x=n(5619),k=n(8425),N=n(5855),I=n(2741),G=n(7814),K=n(9966),M=n(7977),A=n(96),O=n(7764);function H(){return H=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},H.apply(this,arguments)}function _({pr:e,testmergeinfo:t,repoInfo:n,finalState:r,onRemove:a,onSelectCommit:i,onError:o}){const[c,m]=(0,s.useState)(!1),d=e=>{m((t=>{let n;return n="boolean"==typeof e?e:e(t),n&&U(),n}))},[h,g]=(0,s.useState)(!1),[y,b]=(0,s.useState)(e.head),[S,w]=(0,s.useState)(r?r[1]:""),[C,P]=(0,s.useState)(null),[x,k]=(0,s.useState)(null),_=(0,s.useContext)(v.g),U=(0,s.useCallback)((async r=>{if(C&&!r)return;const a=await Z.Z.getPRCommits({owner:n.remoteRepositoryOwner,repo:n.remoteRepositoryName,pr:e,wantedCommit:t?.targetCommitSha});if(a.code===E.G.ERROR)o(a.error);else{const e=new Map;a.payload[0].forEach((t=>e.set(t.sha,t))),P(e),k(a.payload[1]??null)}}),[n.remoteRepositoryOwner,n.remoteRepositoryName,e.head,t?.targetCommitSha]);(0,s.useEffect)((()=>c?void U():void 0),[c,U]),(0,s.useEffect)((()=>h?void U():void 0),[h,U]),(0,s.useEffect)((()=>d(!1)),[r]),(0,s.useEffect)((()=>w(r?r[1]:"")),[r]);let B;t&&(C?.has(t.targetCommitSha)?B=C?.get(t.targetCommitSha):x?.sha===t.targetCommitSha&&(B=x));const j=[...(C??[]).values()].map((n=>({name:n.name,value:n.sha,current:n.sha===t?.targetCommitSha,latest:n.sha===e.head,disabled:!1})));x&&(j.push({name:"...",value:"",current:!1,latest:!1,disabled:!0}),j.push({name:x.name,value:x.sha,current:x.sha===t?.targetCommitSha,latest:x.sha===e.head,disabled:!1}));const D=(0,R.Kp)(_.instancePermissionSet,f.nX.MergePullRequest),F=(0,R.Kp)(_.instancePermissionSet,f.nX.Read)&&(0,R.Kp)(_.instancePermissionSet,f.nX.UpdateBranch)||!t;return s.createElement(s.Fragment,null,s.createElement("tr",null,s.createElement("td",{className:"text-right"+(r?" font-weight-bold":"")},"#",e.number),s.createElement("td",null,s.createElement(M.Z,{pill:!0,className:"text-white text-capitalize mr-2",style:{backgroundColor:{closed:"#c93c37",merged:"#8256d0",open:"#347d39"}[e.state]}},e.state),e.testmergelabel?s.createElement(M.Z,{pill:!0,className:"text-white text-capitalize mr-2",variant:"primary"},s.createElement(u.Z,{id:"view.instance.repo.testmergelabel"})):null),s.createElement("td",null,s.createElement("a",{href:e.link,target:"_blank",rel:"noreferrer"},e.title)),s.createElement("td",{className:"font-italic"},e.author),s.createElement("td",null,s.createElement("div",{className:"d-flex justify-content-center"},s.createElement("div",{className:"d-inline-block text-nowrap"},r?s.createElement(s.Fragment,null,s.createElement(I.Z,{tooltipid:"generic.no_perm",show:!F&&void 0},s.createElement(l.Z,{variant:"danger",className:"mx-1",onClick:a,disabled:!F},s.createElement(G.G,{icon:"minus",fixedWidth:!0}))),s.createElement(I.Z,{tooltipid:"generic.no_perm",show:(!D||!F)&&void 0},s.createElement(l.Z,{className:"mx-1",onClick:n=>n.shiftKey?i(e.head,t?.comment??null):g(!0),variant:r[0]===e.head?"primary":"info",disabled:!D||!F},s.createElement(G.G,{icon:"sync",fixedWidth:!0}))),t?s.createElement(l.Z,{className:"mx-1",onClick:()=>d((e=>!e)),active:c},s.createElement(G.G,{icon:"info",fixedWidth:!0})):null):s.createElement(I.Z,{tooltipid:"generic.no_perm",show:!D&&void 0},s.createElement(l.Z,{variant:"success",className:"mx-1",disabled:!D,onClick:t=>t.shiftKey?i(e.head,null):g(!0)},s.createElement(G.G,{icon:"plus",fixedWidth:!0}))))))),s.createElement("tr",null,s.createElement("td",{className:"py-0 border-top-0"}),s.createElement("td",{colSpan:4,className:"py-0 border-top-0"},t?s.createElement(K.Z,{in:c},s.createElement("div",null,s.createElement("div",{className:"py-3"},s.createElement("table",{className:"reset-table"},s.createElement("tbody",null,s.createElement("tr",null,s.createElement("td",{className:"text-nowrap"},s.createElement("span",{className:"p-2"},s.createElement(u.Z,{id:"view.instance.repo.tm.by"}))),s.createElement("td",null,t.mergedBy.name)),s.createElement("tr",null,s.createElement("td",{className:"text-nowrap"},s.createElement("span",{className:"p-2"},s.createElement(u.Z,{id:"view.instance.repo.tm.comment"}))),s.createElement("td",null,t.comment)),s.createElement("tr",null,s.createElement("td",{className:"text-nowrap"},s.createElement("span",{className:"p-2"},s.createElement(u.Z,{id:"view.instance.repo.tm.commit"}))),s.createElement("td",null,B?s.createElement(s.Fragment,null,B.name,s.createElement("a",{className:"ml-1",href:B.url,target:"_blank",rel:"noreferrer"},"(",t.targetCommitSha.substring(0,7),")")):t.targetCommitSha.substring(0,7)))))))):null)),s.createElement(p.Z,{show:h,onHide:()=>g(!1),centered:!0,size:"lg"},s.createElement(p.Z.Header,{closeButton:!0},s.createElement(p.Z.Title,null,s.createElement(u.Z,{id:"view.instance.repo.tm.modal.title"}))),s.createElement(p.Z.Body,null,s.createElement("h5",null,s.createElement("a",{href:e.link,target:"_blank",rel:"noreferrer",className:"text-decoration-none"},e.title)),s.createElement(u.Z,{id:"view.instance.repo.tm.modal.label"}),C?s.createElement(A.Z,{filterOptions:O.Z,search:!0,options:j,value:y??B?.sha,autoComplete:"on",renderOption:(e,t,n,r)=>s.createElement("button",H({type:"button",className:r+(t.disabled?" font-weight-bold":"")},e),s.createElement(M.Z,null,t.value.substring(0,7)),t.current?s.createElement(M.Z,{variant:"primary",pill:!0,className:"mr-1"},s.createElement(u.Z,{id:"generic.testmerged"})):null,t.latest?s.createElement(M.Z,{variant:"success",pill:!0,className:"mr-1"},s.createElement(u.Z,{id:"generic.latest"})):null,t.name),onChange:e=>b(e)}):s.createElement(N.Z,{text:"loading.repo.commits",width:5,widthUnit:"rem"}),s.createElement(T.ZP,{name:"view.instance.repo.tm.modal.comment",type:T.fS.String,onChange:e=>w(e),defaultValue:t?.comment??""}),s.createElement("span",{className:"text-muted font-italic mt-4 d-inline-block"},s.createElement(u.Z,{id:"view.instance.repo.tm.modal.tip"}))),s.createElement(p.Z.Footer,null,s.createElement(l.Z,{variant:"danger",onClick:()=>g(!1)},s.createElement(u.Z,{id:"generic.close"})),s.createElement(l.Z,{onClick:()=>{y&&i(y,S),g(!1)}},s.createElement(u.Z,{id:"generic.save"})))))}function U(){return U=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},U.apply(this,arguments)}!function(e){e.reapply="reapply",e.added="added",e.removed="removed",e.updated="updated",e.rename="renamed"}(r||(r={})),function(e){e[e.None=0]="None",e[e.Local=1]="Local",e[e.Remote=2]="Remote"}(a||(a={}));class B extends s.Component{constructor(e){super(e),this.state={errors:[],repositoryInfo:null,loading:!0,cloning:!1,unableToHookClone:!1,gitHubPRs:null,manualPRs:new Set,resetType:a.Remote,desiredState:new Map,showDeleteModal:!1,manualPR:0,lastManualPR:0,deployAfter:!1,repoBusy:!1,loadingPRs:!1},this.fetchRepositoryInfo=this.fetchRepositoryInfo.bind(this)}addError(e){this.setState((t=>{const n=Array.from(t.errors);return n.push(e),{errors:n}}))}async componentDidMount(){this.setState({deployAfter:(0,R.$A)(this.context.instancePermissionSet,f.xb.Compile)}),await this.fetchRepositoryInfo(void 0,!0)}async fetchRepositoryInfo(e,t){(0,R.Kp)(this.context.instancePermissionSet,f.nX.Read)||(this.setState({loading:!1,cloning:!1}),this.reloadDesiredState(null,t??!1,!1),this.setState({repositoryInfo:null}));const n=await b.Z.getRepository(this.context.instance.id);if(this.setState({cloning:!1,repoBusy:!1}),n.code===E.G.ERROR)if(n.error.code===y.jK.HTTP_DATA_INEGRITY&&n.error.originalErrorMessage?.errorCode===f.jK.RepoCloning)if(this.setState({cloning:!0,unableToHookClone:!1}),e)w.Z.registerCallback(e.id,this.fetchRepositoryInfo);else{const e=await g.Z.listActiveJobs(this.context.instance.id,{page:1,pageSize:100});if(e.code===E.G.OK){const t=e.payload.content.sort(((e,t)=>t.id-e.id)).find((e=>e.description.includes("Clone")&&e.description.includes("repository")));t?w.Z.registerCallback(t.id,this.fetchRepositoryInfo):this.setState({unableToHookClone:!0})}else this.addError(e.error),this.setState({unableToHookClone:!0})}else n.error.code===y.jK.HTTP_DATA_INEGRITY&&n.error.originalErrorMessage?.errorCode===f.jK.RepoBusy?this.setState({repoBusy:!0}):this.addError(n.error);else this.reloadPRs(n.payload,t),this.setState({repositoryInfo:n.payload});this.setState({loading:!1})}reloadPRs(e,t){e.remoteGitProvider===f.Qs.GitHub&&e.remoteRepositoryName&&e.remoteRepositoryOwner&&(this.setState({loadingPRs:!0}),Z.Z.getPRs({repo:e.remoteRepositoryName,owner:e.remoteRepositoryOwner,wantedPRs:e.revisionInformation?.activeTestMerges.map((e=>e.number))}).then((n=>{this.setState({loadingPRs:!1}),n.code===E.G.ERROR?this.addError(n.error):(this.setState({gitHubPRs:n.payload}),t&&this.reloadDesiredState(e,!0,!1,n.payload))})).catch((e=>{this.setState({loadingPRs:!1}),this.addError(new y.ZP(y.jK.APP_FAIL,{jsError:e}))})))}async applyTestmerges(e){const t={},n=this.state.repositoryInfo,r=this.state.resetType!==a.None;if(this.state.resetType===a.Local?t.checkoutSha=n?.revisionInformation?.originCommitSha:this.state.resetType===a.Remote&&(t.updateFromOrigin=!0,t.reference=n?.reference),n&&n?.remoteGitProvider===f.Qs.GitHub){const n=[];[...this.state.desiredState.entries()].forEach((([t,a])=>{if(!a)return;const[s,i,o]=a;(!s||r||e)&&n.push({number:t,targetCommitSha:i,comment:o})})),n.length&&(t.newTestMerges=n)}const s=t.newTestMerges??[];this.state.manualPRs.forEach((e=>s.push({number:e}))),s.length&&(t.newTestMerges=s),this.setState({loading:!0});const i=await b.Z.editRepository(this.context.instance.id,t);if(this.setState({loading:!1}),i.code===E.G.OK)if(i.payload.activeJob){if(this.setState({loading:!0}),w.Z.fastmode=5,w.Z.registerCallback(i.payload.activeJob.id,(e=>this.fetchRepositoryInfo(e,void 0===e.errorCode&&void 0===e.exceptionDetails))),w.Z.registerJob(i.payload.activeJob,this.context.instance.id),w.Z.restartLoop(),this.state.deployAfter){const e=i.payload.activeJob.id,t=setInterval((()=>{const n=w.Z.jobs.get(e);("number"==typeof n?.progress||n?.stoppedAt)&&(h.Z.startCompile(this.context.instance.id).then((e=>{e.code===E.G.ERROR&&this.addError(e.error)})),clearInterval(t))}),5e3)}}else await this.fetchRepositoryInfo();else this.addError(i.error)}reloadDesiredState(e,t,n,r){r=r??this.state.gitHubPRs,t&&this.setState((e=>({resetType:n?a.None:e.resetType,manualPRs:new Set}))),e&&this.setState((s=>{const i=s.desiredState,o=new Map(t?[]:i);let l=!1;const c=t&&!n;e.revisionInformation?.activeTestMerges.forEach((e=>{const n=o.get(e.number);if(!t){if(!n)return;if(n&&!n[0])return}const a=r?.find((t=>e.number===t.number));if(c&&!("merged"!==a?.state))o.set(e.number,null),l=!0;else{const t=(c?a?.head:null)??e.targetCommitSha;c&&t!==e.targetCommitSha&&(l=!0),o.set(e.number,[!0,t,e.comment??""])}}));return{resetType:l?"(no branch)"===e.reference?a.Local:a.Remote:s.resetType,desiredState:o}}))}render(){return s.createElement("div",{className:"text-center"},s.createElement(k.t,{obj:this.state}),this.renderErrors(),this.state.repositoryInfo&&!this.state.repositoryInfo.origin?this.renderPreClone():s.createElement(s.Fragment,null,s.createElement("h3",null,s.createElement(u.Z,{id:"view.instance.repo.repoinfo"})),this.state.repoBusy?s.createElement(N.Z,{text:"loading.repo.busy"}):s.createElement(s.Fragment,null,this.renderRepoInformation(),s.createElement("hr",null),this.renderSettings(),s.createElement("hr",null),this.renderTestMerges(),s.createElement("hr",null),this.renderDelete())))}renderErrors(){return s.createElement(s.Fragment,null,this.state.errors.map(((e,t)=>{if(e)return s.createElement(C.ZP,{key:t,error:e,onClose:()=>this.setState((e=>{const n=Array.from(e.errors);return n[t]=void 0,{errors:n}}))})})))}renderRepoInformation(){const e=this.state.repositoryInfo;return e?s.createElement("table",{className:"mx-auto text-left"},s.createElement("tbody",null,s.createElement("tr",null,s.createElement("td",null,s.createElement("span",{className:"mr-3"},s.createElement(u.Z,{id:"view.instance.repo.info.origin"}))),s.createElement("td",null,e.origin)),s.createElement("tr",null,s.createElement("td",null,s.createElement("span",{className:"mr-3"},s.createElement(u.Z,{id:"view.instance.repo.info.owner"}))),s.createElement("td",null,e.remoteRepositoryOwner)),s.createElement("tr",null,s.createElement("td",null,s.createElement("span",{className:"mr-3"},s.createElement(u.Z,{id:"view.instance.repo.info.name"}))),s.createElement("td",null,e.remoteRepositoryName)))):s.createElement(P.Z,{title:"view.instance.repo.norepoinfo"})}renderPreClone(){const e={origin:{type:T.fS.String,name:"fields.instance.repository.url"},reference:{type:T.fS.String,name:"fields.instance.repository.ref",defaultValue:""},accessUser:{type:T.fS.String,name:"fields.instance.repository.gituser",defaultValue:""},accessToken:{type:T.fS.String,name:"fields.instance.repository.gitpassword",defaultValue:""},updateSubmodules:{type:T.fS.Boolean,name:"fields.instance.repository.enablesubmodules",defaultValue:!0}};return s.createElement(s.Fragment,null,s.createElement("h3",null,s.createElement(u.Z,{id:"view.instance.repo.clone"})),s.createElement(x.Z,{fields:e,hideDisabled:!(0,R.Kp)(this.context.instancePermissionSet,f.nX.Read),onSave:async e=>{const t={...e};""==e.reference&&(t.reference=null),""==e.accessUser&&(t.accessUser=null),""==e.accessToken&&(t.accessToken=null);const n=await b.Z.cloneRepository(this.context.instance.id,t);n.code===E.G.OK?(await this.fetchRepositoryInfo(n.payload.activeJob??void 0),w.Z.restartLoop()):this.addError(n.error)},includeAll:!0,saveMessageId:"generic.clone"}))}renderSettings(){const e=this.state.repositoryInfo,t={originCheckoutSha:{type:T.fS.String,name:"fields.instance.repository.origincheckoutsha",disabled:!0,defaultValue:e?e.revisionInformation?.originCommitSha:"",tooltip:"fields.instance.repository.origincheckoutsha.desc"},checkoutSha:{type:T.fS.String,name:"fields.instance.repository.checkoutsha",defaultValue:e?e.revisionInformation?.commitSha:"",tooltip:"fields.instance.repository.checkoutsha.desc",disabled:!(0,R.Kp)(this.context.instancePermissionSet,f.nX.SetSha)},reference:{type:T.fS.String,name:"fields.instance.repository.reference",defaultValue:e?e.reference:"",tooltip:"fields.instance.repository.reference.desc",disabled:!(0,R.Kp)(this.context.instancePermissionSet,f.nX.SetReference)},committerName:{type:T.fS.String,name:"fields.instance.repository.committerName",defaultValue:e?e.committerName:"",disabled:!(0,R.Kp)(this.context.instancePermissionSet,f.nX.ChangeCommitter)},committerEmail:{type:T.fS.String,name:"fields.instance.repository.committerEmail",defaultValue:e?e.committerEmail:"",disabled:!(0,R.Kp)(this.context.instancePermissionSet,f.nX.ChangeCommitter)},accessUser:{type:T.fS.String,name:"fields.instance.repository.accessUser",defaultValue:e?e.accessUser:"",tooltip:"fields.instance.repository.accessUser.desc",disabled:!(0,R.Kp)(this.context.instancePermissionSet,f.nX.ChangeCredentials)},accessToken:{type:T.fS.Password,name:"fields.instance.repository.accessToken",tooltip:"fields.instance.repository.accessToken.desc",disabled:!(0,R.Kp)(this.context.instancePermissionSet,f.nX.ChangeCredentials)},clearAccessToken:{type:T.fS.Boolean,name:"fields.instance.repository.clearAccessToken",disabled:!(0,R.Kp)(this.context.instancePermissionSet,f.nX.ChangeCredentials)},pushTestMergeCommits:{type:T.fS.Boolean,name:"fields.instance.repository.pushTestMergeCommits",defaultValue:!!e&&e.pushTestMergeCommits,tooltip:"fields.instance.repository.pushTestMergeCommits.desc",disabled:!(0,R.Kp)(this.context.instancePermissionSet,f.nX.ChangeTestMergeCommits)},createGitHubDeployments:{type:T.fS.Boolean,name:"fields.instance.repository.createGitHubDeployments",defaultValue:!!e&&e.createGitHubDeployments,tooltip:"fields.instance.repository.createGitHubDeployments.desc",disabled:!(0,R.Kp)(this.context.instancePermissionSet,f.nX.ChangeTestMergeCommits)},showTestMergeCommitters:{type:T.fS.Boolean,name:"fields.instance.repository.showTestMergeCommitters",defaultValue:!!e&&e.showTestMergeCommitters,tooltip:"fields.instance.repository.showTestMergeCommitters.desc",disabled:!(0,R.Kp)(this.context.instancePermissionSet,f.nX.ChangeTestMergeCommits)},autoUpdatesKeepTestMerges:{type:T.fS.Boolean,name:"fields.instance.repository.autoUpdatesKeepTestMerges",defaultValue:!!e&&e.autoUpdatesKeepTestMerges,tooltip:"fields.instance.repository.autoUpdatesKeepTestMerges.desc",disabled:!(0,R.Kp)(this.context.instancePermissionSet,f.nX.ChangeAutoUpdateSettings)},autoUpdatesSynchronize:{type:T.fS.Boolean,name:"fields.instance.repository.autoUpdatesSynchronize",defaultValue:!!e&&e.autoUpdatesSynchronize,tooltip:"fields.instance.repository.autoUpdatesSynchronize.desc",disabled:!(0,R.Kp)(this.context.instancePermissionSet,f.nX.ChangeAutoUpdateSettings)},postTestMergeComment:{type:T.fS.Boolean,name:"fields.instance.repository.postTestMergeComment",defaultValue:!!e&&e.postTestMergeComment,tooltip:"fields.instance.repository.postTestMergeComment.desc",disabled:!(0,R.Kp)(this.context.instancePermissionSet,f.nX.ChangeTestMergeCommits)},updateSubmodules:{type:T.fS.Boolean,name:"fields.instance.repository.updateSubmodules",defaultValue:!!e&&e.updateSubmodules,tooltip:"fields.instance.repository.updateSubmodules.desc",disabled:!(0,R.Kp)(this.context.instancePermissionSet,f.nX.ChangeSubmoduleUpdate)}};return s.createElement(s.Fragment,null,s.createElement("h3",null,s.createElement(u.Z,{id:"view.instance.repo.reposettings"})),s.createElement(x.Z,{fields:t,onSave:async e=>{const{clearAccessToken:t,...n}=e;t&&(n.accessUser="",n.accessToken=""),this.setState({loading:!0});const r=await b.Z.editRepository(this.context.instance.id,n);this.setState({loading:!1}),r.code===E.G.OK?r.payload.activeJob?(this.setState({loading:!0}),w.Z.fastmode=5,w.Z.registerCallback(r.payload.activeJob.id,(()=>this.fetchRepositoryInfo(void 0,!0))),w.Z.registerJob(r.payload.activeJob,this.context.instance.id),w.Z.restartLoop()):await this.fetchRepositoryInfo():this.addError(r.error)}}))}renderTestMerges(){const e=this.state.repositoryInfo,t=(0,R.$A)(this.context.instancePermissionSet,f.xb.Compile),n=(0,R.Kp)(this.context.instancePermissionSet,f.nX.MergePullRequest),p=(0,R.Kp)(this.context.instancePermissionSet,f.nX.Read)&&(0,R.Kp)(this.context.instancePermissionSet,f.nX.UpdateBranch),h=new Map;e&&e.revisionInformation?.activeTestMerges.forEach((e=>h.set(e.number,e)));const g=this.state.gitHubPRs?.sort(((e,t)=>h.has(e.number)!==h.has(t.number)?h.has(e.number)?-1:1:e.testmergelabel!==t.testmergelabel?e.testmergelabel?-1:1:e.number-t.number))??[],y=g.map((t=>{const n=this.state.desiredState.get(t.number),a=e?e?.revisionInformation?.activeTestMerges.find((e=>e.number===t.number)):void 0;return n?a?a.targetCommitSha!==n[1]?[r.updated,t]:(a.comment??"")!==n[2]?[r.rename,t]:[r.reapply,t]:[r.added,t]:this.state.desiredState.get(t.number)?null:a?[r.removed,t]:null})).filter((e=>null!==e)),E=y.sort(((e,t)=>{const n=[r.removed,r.reapply,r.added,r.updated];for(const r of n)if(e[0]===r^t[0]===r)return e[0]===r?-1:1;return 0})),b=!!e&&"(no branch)"===e.reference,w=y.some((e=>e[0]!=r.added&&e[0]!=r.reapply)),v=0===y.filter((([e])=>e!==r.reapply)).length&&this.state.resetType===a.None&&!this.state.manualPRs.size;return e&&e.remoteGitProvider==f.Qs.Unknown?s.createElement(P.Z,{title:"view.instance.repo.testmerges.badprovider"}):s.createElement("div",{className:"mx-5"},s.createElement(i.Z,{className:"mb-5"},s.createElement(i.Z.Header,null,s.createElement(u.Z,{id:"view.instance.repo.pending.title"})),s.createElement(i.Z.Body,{className:"text-left"},s.createElement("ul",null,v?s.createElement("li",{className:"font-weight-lighter font-italic"},s.createElement(u.Z,{id:"view.instance.repo.pending.none"})):s.createElement(s.Fragment,null,e&&b?s.createElement("li",null,s.createElement(u.Z,{id:"view.instance.repo.pending.reset.nobranch",values:{commit:e.revisionInformation?.originCommitSha.substring(0,7)}})):this.state.resetType===a.Remote?s.createElement("li",null,s.createElement(u.Z,{id:"view.instance.repo.pending.update"})):this.state.resetType===a.Local?s.createElement("li",null,s.createElement(u.Z,{id:"view.instance.repo.pending.reset"})):null,e&&e.remoteGitProvider===f.Qs.GitHub?E.map((([e,t])=>{const n=this.state.desiredState.get(t.number);if(e===r.reapply&&this.state.resetType===a.None&&!b)return null;let i=n?n[1].substring(0,7):null;const o=this.state.gitHubPRs?.find((e=>t.number===e.number));return i&&!o?.head.startsWith(i)||(i=`HEAD (${(i??o.head).substring(0,7)})`),s.createElement("li",{key:t.number},s.createElement(u.Z,{id:`view.instance.repo.pending.${e}`,values:{number:t.number,commit:i,title:t.title}}))})):null,[...this.state.manualPRs.values()].map((e=>s.createElement("li",{key:e},s.createElement(u.Z,{id:"view.instance.repo.pending.added.manual",values:{number:e}})))),this.state.deployAfter?s.createElement("li",{key:"deploy"},s.createElement(u.Z,{id:"view.instance.repo.pending.deploy"})):null)),s.createElement(o.Z,{size:"lg",className:"mb-2 text-center"},s.createElement(l.Z,{disabled:b||!p,onClick:()=>this.setState({resetType:a.Remote}),variant:this.state.resetType===a.Remote?"secondary":"primary"},s.createElement(u.Z,{id:"view.instance.repo.update.remote"})),s.createElement(c.Z,{placement:"top",overlay:e=>s.createElement(m.Z,U({id:"repo-local-reset-tip"},e),s.createElement(u.Z,{id:"view.instance.repo.update.local.tip"}))},s.createElement(l.Z,{onClick:()=>this.setState({resetType:a.Local}),variant:this.state.resetType===a.Local?"secondary":"primary"},s.createElement(u.Z,{id:"view.instance.repo.update.local"}))),s.createElement(l.Z,{disabled:w,onClick:()=>this.setState({resetType:a.None}),variant:this.state.resetType===a.None?"secondary":"primary"},s.createElement(u.Z,{id:"view.instance.repo.update.none"}))),!S.ZP.manualpr.value&&e&&this.state.gitHubPRs&&e.remoteGitProvider!==f.Qs.GitLab?null:s.createElement("div",{className:"d-flex mt-5"},s.createElement(T.ZP,{name:"view.instance.repo.manual",tooltip:"view.instance.repo.manual.desc",type:T.fS.Number,min:0,defaultValue:this.state.lastManualPR,onChange:e=>this.setState({manualPR:e}),disabled:!n}),s.createElement(I.Z,{tooltipid:"generic.no_perm",show:!n&&void 0},s.createElement(l.Z,{className:"nowrap ml-3",disabled:this.state.manualPR===this.state.lastManualPR||!n,onClick:()=>{this.setState((e=>({manualPRs:new Set([...e.manualPRs.values(),this.state.manualPR]),lastManualPR:this.state.manualPR})))}},s.createElement(u.Z,{id:"view.instance.repo.addmanual"})))),s.createElement(T.ZP,{name:"view.instance.repo.deployAfter",tooltip:"view.instance.repo.deployAfter.desc",type:T.fS.Boolean,defaultValue:!!t&&this.state.deployAfter,disabled:!t,onChange:e=>this.setState({deployAfter:e})})),s.createElement(i.Z.Footer,null,s.createElement(l.Z,{variant:"danger",className:"mx-2",disabled:v,onClick:()=>this.reloadDesiredState(e,!0,!0)},s.createElement(u.Z,{id:"generic.cancel"})),s.createElement(l.Z,{className:"mx-2",disabled:v,onClick:()=>{this.applyTestmerges(b)}},s.createElement(u.Z,{id:"generic.commit"})))),this.state.loadingPRs?s.createElement(N.Z,{text:"loading.repo.prs"}):e?e&&e.remoteGitProvider===f.Qs.GitHub?s.createElement(s.Fragment,null,s.createElement("h3",null,s.createElement(u.Z,{id:"view.instance.repo.testmerges"})),s.createElement("br",null),s.createElement(d.Z,{variant:"dark",striped:!0,hover:!0,className:"text-left"},s.createElement("tbody",null,g.map((t=>s.createElement(_,{key:t.number,testmergeinfo:h.get(t.number),pr:t,repoInfo:e,finalState:!!this.state.desiredState.get(t.number)&&this.state.desiredState.get(t.number).slice(1),onRemove:()=>this.setState((e=>({resetType:e.resetType===a.None?a.Remote:e.resetType,desiredState:new Map(e.desiredState).set(t.number,null)}))),onSelectCommit:(e,n)=>this.setState((r=>({desiredState:new Map(r.desiredState).set(t.number,[!1,e,n])}))),onError:e=>this.addError(e)})))))):null:s.createElement(P.Z,{title:"view.instance.repo.noautomerge"}))}renderDelete(){return s.createElement(s.Fragment,null,s.createElement("h4",null,s.createElement(u.Z,{id:"view.instance.repo.delete.title"})),s.createElement("span",null,s.createElement(u.Z,{id:"view.instance.repo.delete.desc"})),s.createElement("br",null),s.createElement(l.Z,{variant:"danger",className:"mt-2",onClick:()=>this.setState({showDeleteModal:!0})},s.createElement(u.Z,{id:"view.instance.repo.delete"})),s.createElement(p.Z,{show:this.state.showDeleteModal,onHide:()=>this.setState({showDeleteModal:!1}),centered:!0},s.createElement(p.Z.Header,{closeButton:!0},s.createElement(p.Z.Title,null,s.createElement(u.Z,{id:"view.instance.repo.delete.title"}))),s.createElement(p.Z.Body,null,s.createElement("span",null,s.createElement(u.Z,{id:"generic.areyousure"}))),s.createElement(p.Z.Footer,null,s.createElement(l.Z,{onClick:()=>this.setState({showDeleteModal:!1})},s.createElement(u.Z,{id:"generic.cancel"})),s.createElement(l.Z,{variant:"danger",onClick:async()=>{this.setState({showDeleteModal:!1,loading:!0});const e=await b.Z.deleteRepository(this.context.instance.id);this.setState({loading:!1}),e.code===E.G.OK?e.payload.activeJob?(this.setState({loading:!0}),w.Z.fastmode=5,w.Z.registerCallback(e.payload.activeJob.id,(e=>this.fetchRepositoryInfo(e,void 0===e.errorCode&&void 0===e.exceptionDetails))),w.Z.registerJob(e.payload.activeJob,this.context.instance.id),w.Z.restartLoop()):await this.fetchRepositoryInfo():this.addError(e.error)}},s.createElement(u.Z,{id:"view.instance.repo.delete"})))))}}B.contextType=v.g;var j=B},7428:function(e,t,n){var r=n(7162),a=n(7347),s=n(2638),i=n(2527),o=n(6846),l=n(3803),c=n(7961),m=n(6755);async function d(e,t,n){const r=e.endpoint.merge(t,n);return c.ZP.githubtoken.value&&(r.headers.authorization=`token ${c.ZP.githubtoken.value}`),e(r)}async function p(){return c.ZP.githubtoken.value?{type:"token",tokenType:"pat",token:c.ZP.githubtoken.value}:{type:"unauthenticated"}}const u=()=>Object.assign(p.bind(null),{hook:d.bind(null)}),h=new class extends i.TypedEmitter{constructor(){super(),this.apiClient=void 0;const e=s.v.plugin(r.X,a.O);this.apiClient=new e({authStrategy:u,userAgent:"tgstation-server-control-panel/"+m.q4,baseUrl:"https://api.github.com",throttle:{onRateLimit:(e,t)=>(console.warn(`Request quota exhausted for request ${t.method} ${t.url}`),0===t.request.retryCount&&(console.log(`Retrying after ${e} seconds!`),!0)),onAbuseLimit:(e,t)=>{console.warn(`Abuse detected for request ${t.method} ${t.url}`)}}})}async getVersions({owner:e,repo:t,current:n,all:r}){let a,s=0;try{a=await this.apiClient.paginate(this.apiClient.repos.listReleases,{owner:e,repo:t},((e,t)=>e.data.reduce(((e,a)=>{const i=/tgstation-server-v([\d.]+)/.exec(a.name??"");if(!i)return e;if("4"!==i[1][0]&&"5"!==i[1][0])return e;const o=i[1];let l=!1;if(o<=n){if(s>=3&&!r)return t(),e;s++,l=!0}return e.push({version:o,body:a.body??"",current:o===n,old:l}),e}),[])))}catch(e){return new l.Z({code:l.G.ERROR,error:new o.ZP(o.jK.GITHUB_FAIL,{jsError:e})})}return new l.Z({code:l.G.OK,payload:a})}transformPR(e){return{number:e.number,title:e.title,author:e.user?.login??"ghost",state:e.merged_at?"merged":e.state,link:e.html_url,head:e.head.sha,tail:e.base.sha,testmergelabel:e.labels.some((e=>e.name?.toLowerCase().includes("testmerge")||e.name?.toLowerCase().includes("test merge")))}}async getPRs({owner:e,repo:t,wantedPRs:n}){let r=[];try{r=(await this.apiClient.paginate(this.apiClient.pulls.list,{owner:e,repo:t,state:"open"})).map(this.transformPR);for(const a of n??[])if(!r.find((e=>e.number==a))){const n=(await this.apiClient.pulls.get({owner:e,repo:t,pull_number:a})).data;r.push(this.transformPR(n))}}catch(e){return console.error(e),new l.Z({code:l.G.ERROR,error:new o.ZP(o.jK.GITHUB_FAIL,{jsError:e})})}return new l.Z({code:l.G.OK,payload:r})}async getPRCommits({owner:e,repo:t,pr:n,wantedCommit:r}){let a,s=[];try{if(s=await this.apiClient.paginate(this.apiClient.pulls.listCommits,{owner:e,repo:t,pull_number:n.number,per_page:100},(({data:e})=>e.map((e=>({name:e.commit.message.split("\n")[0],sha:e.sha,url:e.html_url}))))),s.reverse(),r&&!s.find((e=>e.sha===r))){const n=(await this.apiClient.repos.getCommit({owner:e,repo:t,ref:r})).data;a={name:n.commit.message.split("\n")[0],sha:n.sha,url:n.html_url}}}catch(e){return console.error(e),new l.Z({code:l.G.ERROR,error:new o.ZP(o.jK.GITHUB_FAIL,{jsError:e})})}return new l.Z({code:l.G.OK,payload:[s,a]})}async getFile(e,t,n){try{const{data:r}=await this.apiClient.repos.getContent({mediaType:{format:"base64"},owner:e,repo:t,path:n});if(Array.isArray(r))return new l.Z({code:l.G.ERROR,error:new o.ZP(o.jK.GITHUB_FAIL,{jsError:new Error(`${n} was a directory!`)})});if("file"!==r.type)return new l.Z({code:l.G.ERROR,error:new o.ZP(o.jK.GITHUB_FAIL,{jsError:new Error(`${n} has type ${r.type}!`)})});const a=r.content;return new l.Z({code:l.G.OK,payload:a})}catch(e){return console.error(e),new l.Z({code:l.G.ERROR,error:new o.ZP(o.jK.GITHUB_FAIL,{jsError:e})})}}async getDirectoryContents(e,t,n){try{const{data:r}=await this.apiClient.repos.getContent({owner:e,repo:t,path:n});if(!Array.isArray(r))return new l.Z({code:l.G.ERROR,error:new o.ZP(o.jK.GITHUB_FAIL,{jsError:new Error(`${n} was not a directory!`)})});const a=[];return r.forEach((e=>a.push({path:e.path,isDirectory:"dir"==e.type}))),new l.Z({code:l.G.OK,payload:a})}catch(e){return console.error(e),new l.Z({code:l.G.ERROR,error:new o.ZP(o.jK.GITHUB_FAIL,{jsError:e})})}}};t.Z=h}}]);
//# sourceMappingURL=264.2c0101afa3dd1b0636bc.bundle.js.map