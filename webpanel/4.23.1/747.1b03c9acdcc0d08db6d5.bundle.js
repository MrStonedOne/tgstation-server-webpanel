"use strict";(self.webpackChunktgstation_server_control_panel=self.webpackChunktgstation_server_control_panel||[]).push([[747],{8747:function(e,t,r){r.r(t),r.d(t,{default:function(){return O}});var a=r(7294),n=r(5509),s=r(6841),i=r(8375),o=r(5005),c=r(1555),l=r(2258),u=r(2318),m=r(4012),d=r(5977),h=r(5006),p=r.n(h),w=r(6222),E=r(3637),f=r(7179),g=r(5856),Z=r(8509),v=r(6352),S=r(6846),y=r(3803),R=r(7611),k=r(9521),b=r(4615),x=r(7428);var C=r(1320),G=r(3e3),q=r(5855);class N extends a.Component{constructor(e,t){super(e),this.state={loading:!1,errors:[],prefix:t.serverInfo.validInstancePaths?.length?t.serverInfo.validInstancePaths[0]:void 0,tab:"quick",performingQuickSetup:!1,quickSetupStages:[]},this.submit=this.submit.bind(this),this.quickStart=this.quickStart.bind(this)}addError(e){this.setState((t=>{const r=Array.from(t.errors);return r.push(e),{errors:r}}))}render(){if(this.state.loading)return a.createElement(q.Z,{text:"view.instance.create.loading"});const e=this.context.serverInfo.validInstancePaths;return a.createElement("div",{className:"text-center"},this.state.errors.map(((e,t)=>{if(e)return a.createElement(G.ZP,{key:t,error:e,onClose:()=>this.setState((e=>{const r=Array.from(e.errors);return r[t]=void 0,{errors:r}}))})})),a.createElement("h3",null,a.createElement(m.Z,{id:"view.instance.create.title"})),this.state.performingQuickSetup?a.createElement("div",null,a.createElement(q.Z,{text:"view.instance.create.quick.active"}),a.createElement("ul",null,this.state.quickSetupStages)):a.createElement(n.Z,{activeKey:this.state.tab,onSelect:e=>{e&&this.setState({tab:e})},id:"create-instance-tabs",className:"justify-content-center mb-3 mt-4 flex-column flex-md-row"},a.createElement(s.Z,{eventKey:"quick",title:a.createElement(m.Z,{id:"view.instance.create.quick"})},this.renderQuickSetup()),a.createElement(s.Z,{eventKey:"manual",title:a.createElement(m.Z,{id:"view.instance.create.manual"})},a.createElement(l.Z,{onSubmit:this.submit},a.createElement(c.Z,{className:"mx-auto",lg:5,md:8},a.createElement(l.Z.Group,{controlId:"name"},a.createElement(l.Z.Label,null,a.createElement("h5",null,a.createElement(m.Z,{id:"view.instance.create.name"}))),a.createElement(l.Z.Control,{type:"text",onChange:e=>{const t=e.target.value;this.setState({instanceName:t})},value:this.state.instanceName,required:!0})),a.createElement(l.Z.Group,{controlId:"path"},a.createElement(l.Z.Label,null,a.createElement("h5",null,a.createElement(m.Z,{id:"view.instance.create.path"}))),a.createElement(u.Z,{className:"mb-1"},null!=e?a.createElement(u.Z.Prepend,{className:"flex-grow-1 flex-grow-md-0"},a.createElement(u.Z.Text,null,a.createElement("span",null,a.createElement(m.Z,{id:"view.instance.create.path.prefix"}))),a.createElement(l.Z.Control,{className:"rounded-0 flex-grow-1 flex-grow-md-0 flex-shrink-0 flex-shrink-md-1 w-auto",as:"select",custom:!0,required:!0,onChange:e=>{this.setState({prefix:e.target.value})}},e.map((e=>a.createElement("option",{key:e,value:e,selected:this.state.prefix==e},e,"/"))))):null,a.createElement(l.Z.Control,{type:"text",className:"flex-grow-1 w-100 w-md-auto",required:!0,onChange:e=>{const t=e.target.value;this.setState({instancePath:t})},value:this.state.instancePath}))),a.createElement(o.Z,{type:"submit",variant:"success"},a.createElement(m.Z,{id:"view.instance.create.submit"})))))))}renderQuickSetup(){const e=this.context.serverInfo.validInstancePaths;return a.createElement("div",null,a.createElement(i.Z,{className:"clearfix",variant:"primary"},a.createElement(m.Z,{id:"view.instance.create.quick.notice",values:{br:a.createElement("br",null)}})),a.createElement(i.Z,{className:"clearfix",variant:"error"},a.createElement(m.Z,{id:"view.instance.create.quick.warning"})),a.createElement(l.Z,{onSubmit:this.quickStart},a.createElement(c.Z,{className:"mx-auto",lg:5,md:8},a.createElement(l.Z.Group,{controlId:"quickname"},a.createElement(l.Z.Label,null,a.createElement("h5",null,a.createElement(m.Z,{id:"view.instance.create.name"}))),a.createElement(l.Z.Control,{type:"text",onChange:e=>{const t=e.target.value;this.setState({instanceName:t})},value:this.state.instanceName,required:!0})),a.createElement(l.Z.Group,{controlId:"quickpath"},a.createElement(l.Z.Label,null,a.createElement("h5",null,a.createElement(m.Z,{id:"view.instance.create.path"}))),a.createElement(u.Z,{className:"mb-1"},null!=e?a.createElement(u.Z.Prepend,{className:"flex-grow-1 flex-grow-md-0"},a.createElement(u.Z.Text,null,a.createElement("span",null,a.createElement(m.Z,{id:"view.instance.create.path.prefix"}))),a.createElement(l.Z.Control,{className:"rounded-0 flex-grow-1 flex-grow-md-0 flex-shrink-0 flex-shrink-md-1 w-auto",as:"select",custom:!0,required:!0,onChange:e=>{this.setState({prefix:e.target.value})}},e.map((e=>a.createElement("option",{key:e,value:e,selected:this.state.prefix==e},e,"/"))))):null,a.createElement(l.Z.Control,{type:"text",className:"flex-grow-1 w-100 w-md-auto",required:!0,onChange:e=>{const t=e.target.value;this.setState({instancePath:t})},value:this.state.instancePath}))),a.createElement(l.Z.Group,{controlId:"repoowner"},a.createElement(l.Z.Label,null,a.createElement("h5",null,a.createElement(m.Z,{id:"view.instance.create.repo_owner"}))),a.createElement(u.Z,{className:"mb-1"},a.createElement(l.Z.Control,{type:"text",className:"flex-grow-1 w-100 w-md-auto",required:!0,onChange:e=>{const t=e.target.value;this.setState({repoOwner:t})},value:this.state.repoOwner}))),a.createElement(l.Z.Group,{controlId:"reponame"},a.createElement(l.Z.Label,null,a.createElement("h5",null,a.createElement(m.Z,{id:"view.instance.create.repo_name"}))),a.createElement(u.Z,{className:"mb-1"},a.createElement(l.Z.Control,{type:"text",className:"flex-grow-1 w-100 w-md-auto",required:!0,onChange:e=>{const t=e.target.value;this.setState({repoName:t})},value:this.state.repoName}))),a.createElement(l.Z.Group,{controlId:"accessuser"},a.createElement(l.Z.Label,null,a.createElement("h5",null,a.createElement(m.Z,{id:"view.instance.create.access_user"}))),a.createElement(u.Z,{className:"mb-1"},a.createElement(l.Z.Control,{type:"text",className:"flex-grow-1 w-100 w-md-auto",onChange:e=>{const t=e.target.value;this.setState({accessUser:t})},value:this.state.accessUser}))),a.createElement(l.Z.Group,{controlId:"accesstoken"},a.createElement(l.Z.Label,null,a.createElement("h5",null,a.createElement(m.Z,{id:"view.instance.create.access_token"}))),a.createElement(u.Z,{className:"mb-1"},a.createElement(l.Z.Control,{type:"password",className:"flex-grow-1 w-100 w-md-auto",onChange:e=>{const t=e.target.value;this.setState({accessToken:t})},value:this.state.accessToken}))),a.createElement(o.Z,{type:"submit",variant:"success"},a.createElement(m.Z,{id:"view.instance.create.quick.submit"})))))}pushStage(e){this.setState((t=>{const r=[...t.quickSetupStages];return r.push(a.createElement("li",null,e)),{quickSetupStages:r}}))}async quickStart(){if(!(this.state.instancePath&&this.state.instanceName&&this.state.repoName&&this.state.repoOwner))return;this.setState({performingQuickSetup:!0,quickSetupStages:[]}),this.pushStage(a.createElement(m.Z,{id:"view.instance.create.quick.stage.yml"}));const e=await x.Z.getFile(this.state.repoOwner,this.state.repoName,".tgs.yml");if(e.code===y.G.ERROR)return this.addError(e.error),void this.setState({performingQuickSetup:!1});const t=window.atob(e.payload);let r;try{r=p().parse(t)}catch(e){return void this.setState({performingQuickSetup:!1})}1!==r.version&&(this.addError(new S.ZP(S.jK.BAD_TGS_YML_VERSION,{void:!0})),this.setState({performingQuickSetup:!1}));const n=(this.context.serverInfo.windowsHost?r.windows_scripts:r.linux_scripts)??{},s=function(e){switch(e.security?.toLowerCase()){case"ultrasafe":return Z.ns.Ultrasafe;case"safe":return Z.ns.Safe;case"trusted":return Z.ns.Trusted;default:return null}}(r)??Z.ns.Safe;try{const e=new Map,t=Object.keys(n);if(t.length>0)for(const r of t){const t=n[r];this.pushStage(a.createElement(m.Z,{id:"view.instance.create.quick.stage.download_scripts",values:{script:r}}));const s=await x.Z.getFile(this.state.repoOwner,this.state.repoName,t);if(s.code===y.G.ERROR)return this.addError(s.error),void this.setState({performingQuickSetup:!1});e.set(r,s.payload)}this.pushStage(a.createElement(m.Z,{id:"view.instance.create.quick.stage.create_instance"}));const i=(this.state.prefix?this.state.prefix+"/":"")+this.state.instancePath,o=await v.Z.createInstance({name:this.state.instanceName,path:i,configurationType:Z.c7.HostWrite});if(o.code===y.G.ERROR)return this.addError(o.error),void this.setState({performingQuickSetup:!1});const c=o.payload.id,l=await v.Z.editInstance({id:c,online:!0});if(l.code===y.G.ERROR)return this.addError(l.error),void this.setState({performingQuickSetup:!1});this.pushStage(a.createElement(m.Z,{id:"view.instance.create.quick.stage.cloning"}));const u=await R.Z.cloneRepository(c,{origin:`https://github.com/${this.state.repoOwner}/${this.state.repoName}`,updateSubmodules:!0});if(u.code===y.G.ERROR)return this.addError(u.error),void this.setState({performingQuickSetup:!1});if(k.Z.registerJob(u.payload.activeJob,c),r.byond){this.pushStage(a.createElement(m.Z,{id:"view.instance.create.quick.stage.byond",values:{version:r.byond}}));const e=await w.Z.switchActive(c,r.byond);if(e.code===y.G.ERROR)return this.addError(e.error),void this.setState({performingQuickSetup:!1});k.Z.registerJob(e.payload.installJob,c)}if(s!=Z.ns.Safe){this.pushStage(a.createElement(m.Z,{id:"view.instance.create.quick.stage.settings"}));const e=await g.Z.updateDeployInfo(c,{apiValidationSecurityLevel:s});if(e.code===y.G.ERROR)return this.addError(e.error),void this.setState({performingQuickSetup:!1});const t=await f.Z.updateWatchdogStatus(c,{securityLevel:s});if(t.code===y.G.ERROR)return this.addError(t.error),void this.setState({performingQuickSetup:!1})}const d=e=>{const t=window.atob(e),r=t.length,a=new Uint8Array(r);for(let e=0;e<r;e++)a[e]=t.charCodeAt(e);return a.buffer};for(const t of e){this.pushStage(a.createElement(m.Z,{id:"view.instance.create.quick.stage.upload_scripts",values:{script:t[0]}}));const e=await E.Z.writeConfigFile(c,{path:`EventScripts/${t[0]}`},d(t[1]));if(e.code===y.G.ERROR)return this.addError(e.error),void this.setState({performingQuickSetup:!1})}if(r.static_files)for(const e of r.static_files)if(this.pushStage(a.createElement(m.Z,{id:"view.instance.create.quick.stage.static",values:{dir:e.name}})),e.populate){let t=!0;const r=async e=>{const n=await x.Z.getDirectoryContents(this.state.repoOwner,this.state.repoName,e);if(n.code===y.G.ERROR)return this.addError(n.error),this.setState({performingQuickSetup:!1}),void(t=!1);for(const e of n.payload)if(e.isDirectory){if(await r(e.path),!t)return}else{this.pushStage(a.createElement(m.Z,{id:"view.instance.create.quick.stage.static.transfer",values:{path:e.path}}));const r=await x.Z.getFile(this.state.repoOwner,this.state.repoName,e.path);if(r.code===y.G.ERROR)return this.addError(r.error),this.setState({performingQuickSetup:!1}),void(t=!1);const n=await E.Z.writeConfigFile(c,{path:`GameStaticFiles/${e.path}`},d(r.payload));if(n.code===y.G.ERROR)return this.addError(n.error),this.setState({performingQuickSetup:!1}),void(t=!1)}};if(await r(e.name),!t)return}else{this.pushStage(a.createElement(m.Z,{id:"view.instance.create.quick.stage.static",values:{script:e.name}}));const t=await E.Z.addDirectory(c,{path:`GameStaticFiles/${e.name}`});if(t.code===y.G.ERROR)return this.addError(t.error),void this.setState({performingQuickSetup:!1})}C.Mq.selectedinstanceid=c,this.props.history.push(C.$w.instanceedit.link??C.$w.instanceedit.route)}catch(e){this.addError(new S.ZP(S.jK.BAD_TGS_YML,{jsError:e})),this.setState({performingQuickSetup:!1})}}async submit(){if(!this.state.instancePath||!this.state.instanceName)return;const e=(this.state.prefix?this.state.prefix+"/":"")+this.state.instancePath;this.setState({loading:!0});const t=await v.Z.createInstance({name:this.state.instanceName,path:e});if(t.code===y.G.ERROR)return this.setState({loading:!1}),void this.addError(t.error);C.Mq.selectedinstanceid=t.payload.id,this.props.history.push(C.$w.instancelist.link??C.$w.instancelist.route)}}N.contextType=b.f;var O=(0,d.EN)(N)},7428:function(e,t,r){var a=r(7162),n=r(7347),s=r(2638),i=r(2527),o=r(6846),c=r(3803),l=r(7961),u=r(6755);async function m(e,t,r){const a=e.endpoint.merge(t,r);return l.ZP.githubtoken.value&&(a.headers.authorization=`token ${l.ZP.githubtoken.value}`),e(a)}async function d(){return l.ZP.githubtoken.value?{type:"token",tokenType:"pat",token:l.ZP.githubtoken.value}:{type:"unauthenticated"}}const h=()=>Object.assign(d.bind(null),{hook:m.bind(null)}),p=new class extends i.TypedEmitter{constructor(){super(),this.apiClient=void 0;const e=s.v.plugin(a.X,n.O);this.apiClient=new e({authStrategy:h,userAgent:"tgstation-server-control-panel/"+u.q4,baseUrl:"https://api.github.com",throttle:{onRateLimit:(e,t)=>(console.warn(`Request quota exhausted for request ${t.method} ${t.url}`),0===t.request.retryCount&&(console.log(`Retrying after ${e} seconds!`),!0)),onAbuseLimit:(e,t)=>{console.warn(`Abuse detected for request ${t.method} ${t.url}`)}}})}async getVersions({owner:e,repo:t,current:r,all:a}){let n,s=0;try{n=await this.apiClient.paginate(this.apiClient.repos.listReleases,{owner:e,repo:t},((e,t)=>e.data.reduce(((e,n)=>{const i=/tgstation-server-v([\d.]+)/.exec(n.name??"");if(!i)return e;if("4"!==i[1][0]&&"5"!==i[1][0])return e;const o=i[1];let c=!1;if(o<=r){if(s>=3&&!a)return t(),e;s++,c=!0}return e.push({version:o,body:n.body??"",current:o===r,old:c}),e}),[])))}catch(e){return new c.Z({code:c.G.ERROR,error:new o.ZP(o.jK.GITHUB_FAIL,{jsError:e})})}return new c.Z({code:c.G.OK,payload:n})}transformPR(e){return{number:e.number,title:e.title,author:e.user?.login??"ghost",state:e.merged_at?"merged":e.state,link:e.html_url,head:e.head.sha,tail:e.base.sha,testmergelabel:e.labels.some((e=>e.name?.toLowerCase().includes("testmerge")||e.name?.toLowerCase().includes("test merge")))}}async getPRs({owner:e,repo:t,wantedPRs:r}){let a=[];try{a=(await this.apiClient.paginate(this.apiClient.pulls.list,{owner:e,repo:t,state:"open"})).map(this.transformPR);for(const n of r??[])if(!a.find((e=>e.number==n))){const r=(await this.apiClient.pulls.get({owner:e,repo:t,pull_number:n})).data;a.push(this.transformPR(r))}}catch(e){return console.error(e),new c.Z({code:c.G.ERROR,error:new o.ZP(o.jK.GITHUB_FAIL,{jsError:e})})}return new c.Z({code:c.G.OK,payload:a})}async getPRCommits({owner:e,repo:t,pr:r,wantedCommit:a}){let n,s=[];try{if(s=await this.apiClient.paginate(this.apiClient.pulls.listCommits,{owner:e,repo:t,pull_number:r.number,per_page:100},(({data:e})=>e.map((e=>({name:e.commit.message.split("\n")[0],sha:e.sha,url:e.html_url}))))),s.reverse(),a&&!s.find((e=>e.sha===a))){const r=(await this.apiClient.repos.getCommit({owner:e,repo:t,ref:a})).data;n={name:r.commit.message.split("\n")[0],sha:r.sha,url:r.html_url}}}catch(e){return console.error(e),new c.Z({code:c.G.ERROR,error:new o.ZP(o.jK.GITHUB_FAIL,{jsError:e})})}return new c.Z({code:c.G.OK,payload:[s,n]})}async getFile(e,t,r){try{const{data:a}=await this.apiClient.repos.getContent({mediaType:{format:"base64"},owner:e,repo:t,path:r});if(Array.isArray(a))return new c.Z({code:c.G.ERROR,error:new o.ZP(o.jK.GITHUB_FAIL,{jsError:new Error(`${r} was a directory!`)})});if("file"!==a.type)return new c.Z({code:c.G.ERROR,error:new o.ZP(o.jK.GITHUB_FAIL,{jsError:new Error(`${r} has type ${a.type}!`)})});const n=a.content;return new c.Z({code:c.G.OK,payload:n})}catch(e){return console.error(e),new c.Z({code:c.G.ERROR,error:new o.ZP(o.jK.GITHUB_FAIL,{jsError:e})})}}async getDirectoryContents(e,t,r){try{const{data:a}=await this.apiClient.repos.getContent({owner:e,repo:t,path:r});if(!Array.isArray(a))return new c.Z({code:c.G.ERROR,error:new o.ZP(o.jK.GITHUB_FAIL,{jsError:new Error(`${r} was not a directory!`)})});const n=[];return a.forEach((e=>n.push({path:e.path,isDirectory:"dir"==e.type}))),new c.Z({code:c.G.OK,payload:n})}catch(e){return console.error(e),new c.Z({code:c.G.ERROR,error:new o.ZP(o.jK.GITHUB_FAIL,{jsError:e})})}}};t.Z=p}}]);
//# sourceMappingURL=747.1b03c9acdcc0d08db6d5.bundle.js.map