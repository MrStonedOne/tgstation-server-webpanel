"use strict";(self.webpackChunktgstation_server_control_panel=self.webpackChunktgstation_server_control_panel||[]).push([[926],{6642:function(e,t,i){i.d(t,{Z:function(){return l}});var s=i(7294),n=i(5881),a=i(4012),r=i(6755);class l extends s.Component{render(){return s.createElement(n.Z,{className:"bg-transparent",border:"info"},s.createElement(n.Z.Header,{className:"bg-info text-dark font-weight-bold"},s.createElement(a.Z,{id:"generic.wip"})),s.createElement(n.Z.Body,null,s.createElement(n.Z.Title,null,s.createElement(a.Z,{id:"generic.wip.desc"}),s.createElement("a",{href:"https://github.com/tgstation/Tgstation.Server.ControlPanel/releases/latest"},"https://github.com/tgstation/Tgstation.Server.ControlPanel/releases/latest")),s.createElement(n.Z.Text,{as:"pre",className:"bg-transparent text-info"},s.createElement("code",null,`Version: ${r.q4}\nWebpanel Mode: ${r.IK}\nCurrent route: ${window.location.toString()}`))))}}},926:function(e,t,i){i.r(t);var s=i(1436),n=i(7814),a=i(8256),r=i(7294),l=i(5005),o=i(2086),c=i(5293),d=i(3489),h=i(4012),p=i(4806),f=i(3637),m=i(8509),y=i(3803),u=i(6190),w=i(6964),E=i(3e3),g=i(9635),v=i(9049),x=i(5619),R=i(8425),Z=i(5855),D=i(6642);function b(){return b=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(e[s]=i[s])}return e},b.apply(this,arguments)}const F=(e,t)=>{const i=window.navigator;if(i&&i.msSaveOrOpenBlob)i.msSaveOrOpenBlob(t,e);else{const i=document.createElement("a");document.body.appendChild(i);const s=URL.createObjectURL(t);i.href=s,i.download=e,i.click(),URL.revokeObjectURL(i.href),i.remove()}};class S{constructor(e,t){this.parent=void 0,this.children=void 0,this.fileResponse=void 0,this.totalFiles=void 0,this.fullyLoaded=!1,this.fileResponse=e,this.parent=t??null,e.isDirectory||(this.fullyLoaded=!0),this.children=[]}}class C extends r.Component{constructor(e){super(e),this.state={errors:[],rootDirectory:null,loading:!0,selectedFile:null,selectedCreateNode:null},this.createEntity=this.createEntity.bind(this),this.selectFile=this.selectFile.bind(this),this.shortAsyncAction=this.shortAsyncAction.bind(this),this.deleteFile=this.deleteFile.bind(this),this.loadDirectory=this.loadDirectory.bind(this),this.clearDirectory=this.clearDirectory.bind(this)}addError(e){this.setState((t=>{const i=Array.from(t.errors);return i.push(e),{errors:i}}))}async componentDidMount(){await this.loadRootDir()}async loadRootDir(){if((0,w.H5)(this.context.instancePermissionSet,m.TI.List)){this.setState({loading:!0});const e=new S({path:"/",isDirectory:!0,fileTicket:""});await this.loadDirectory(e),this.setState({rootDirectory:e,loading:!1})}else this.setState({loading:!1})}async shortAsyncAction(e){const t=e();let i=!1;const s=new Promise((e=>setTimeout(e,750))).then((()=>{i=!0}));await Promise.race([t,s]),i?(this.setState({loading:!0}),await t,this.setState({loading:!1})):this.forceUpdate()}async deleteDirectory(e){const t=await f.Z.deleteDirectory(this.context.instance.id,{path:e.fileResponse.path});if(t.code===y.G.OK){if(null!=e.parent){const t=e.parent.children.indexOf(e);e.parent.children.splice(t,1),this.forceUpdate()}}else this.addError(t.error)}async loadDirectory(e){if((0,w.H5)(this.context.instancePermissionSet,m.TI.List)){this.clearDirectory(e);const t="\\"===e.fileResponse.path[0]||"/"===e.fileResponse.path[0]?e.fileResponse.path.slice(1):e.fileResponse.path;let i=1;for(let s=1;s<=i;++s){const n=await f.Z.getDirectory(this.context.instance.id,t,{page:s});if(n.code!==y.G.OK){this.addError(n.error);break}{i=n.payload.totalPages,i<=s&&(e.fullyLoaded=!0);const t=n.payload.content.map((t=>new S(t,e)));for(const i of t)e.children.push(i)}}e.children=e.children.sort().reverse().sort(((e,t)=>t.fileResponse.isDirectory?1:0))}}async selectFile(e){if(this.state.selectedFile===e)return void this.setState({selectedFile:null});let t=e.fileResponse.path;for(;t.startsWith("/");)t=t.substring(1);if(!e.fileResponse.isDirectory){const i=await f.Z.getConfigFile(this.context.instance.id,t,!1);i.code===y.G.OK?e.fileResponse=i.payload:(this.addError(i.error),e.fileResponse.lastReadHash=null)}this.setState({selectedFile:e,selectedCreateNode:null})}async deleteFile(){const e=this.state.selectedFile,t=await f.Z.writeConfigFile(this.context.instance.id,{path:e.fileResponse.path,lastReadHash:e.fileResponse.lastReadHash},new Uint8Array);if(t.code===y.G.OK){const t=e.parent,i=t.children.indexOf(e);t.children.splice(i,1),this.setState({selectedFile:null})}else this.addError(t.error)}async downloadDirectory(e){if(!confirm(this.props.intl.formatMessage({id:"view.instance.files.zip.confirm"},{path:e.fileResponse.path})))return;this.setState({loading:!0});const t=async e=>{let t=[],i=1;const s="\\"===e.path[0]||"/"===e.path[0]?e.path.slice(1):e.path;for(let e=1;e<=i;++e){const n=await f.Z.getDirectory(this.context.instance.id,s,{page:e});if(n.code!==y.G.OK)return this.addError(n.error),null;i=n.payload.totalPages,t=t.concat(n.payload.content)}return t};let i=!1;const s=async t=>{const s=await f.Z.getConfigFile(this.context.instance.id,t.path,!0),n=t.path.substring(e.fileResponse.path.length);if(s.code===y.G.OK){const e=s.payload;return new File([e.content],n)}return this.addError(s.error),i=!0,null};let n=[e.fileResponse];const r=[];for(;n.length>0;){const e=[];if(n.forEach((i=>e.push(t(i)))),n=[],await Promise.all(e),i)return void this.setState({loading:!1});for(const t of e){const e=await t;if(null==e)return void this.setState({loading:!1});e.forEach((e=>{e.isDirectory?n.push(e):r.push(s(e))}))}}if(await Promise.all(r),i)return void this.setState({loading:!1});const l=[];for(const e of r)l.push(await e);const o=await(0,a.RZ)(l).blob(),c=Math.max(e.fileResponse.path.lastIndexOf("\\"),e.fileResponse.path.lastIndexOf("/")),d=e.fileResponse.path.slice(c+1)+".zip";F(d,o),this.setState({loading:!1})}async downloadFile(){this.setState({loading:!0});const e=this.state.selectedFile,t=await f.Z.getConfigFile(this.context.instance.id,e.fileResponse.path,!0);if(t.code===y.G.OK){const i=Math.max(e.fileResponse.path.lastIndexOf("\\"),e.fileResponse.path.lastIndexOf("/")),s=e.fileResponse.path.slice(i+1);F(s,t.payload.content)}else this.addError(t.error);this.setState({loading:!1})}async createEntity(e,t){let i;if(e.isDirectory)i=new Uint8Array;else{const e=new Promise((e=>{const t=document.createElement("input");t.type="file",t.onchange=t=>{const i=t.target?.files;e(i?i[0]:null)},t.click()})),t=await e;if(!t)return;i=await t.arrayBuffer()}this.setState({loading:!0});let s=t.fileResponse.path;e.replace?s="/"+s:s+="/"+e.entityName,s.startsWith("//")&&(s=s.substring(1)),e.isDirectory&&(s+="/webpanel.dir.create.tmp");const n=await f.Z.writeConfigFile(this.context.instance.id,{path:s,lastReadHash:e.replace?t.fileResponse.lastReadHash:null},i);n.code!==y.G.OK?this.addError(n.error):e.replace&&(t.fileResponse=n.payload),e.replace||(t.fullyLoaded=!1,await this.loadDirectory(t));let a=s.replace("\\","/");a.startsWith("/")&&(a=a.substring(1));const r=t.children.find((e=>a.startsWith(e.fileResponse.path.replace("\\","/"))))??null;r&&(e.isDirectory?(await this.loadDirectory(r),this.setState({selectedCreateNode:null,selectedFile:null})):await this.selectFile(r)),this.setState({loading:!1})}clearDirectory(e){e.fullyLoaded=!1,e.children.forEach((e=>{e===this.state.selectedFile?this.setState({selectedFile:null}):e===this.state.selectedCreateNode&&this.setState({selectedCreateNode:null}),e.fileResponse.isDirectory&&this.clearDirectory(e)})),e.children=[]}render(){if(this.state.loading)return r.createElement(Z.Z,{text:"loading.instance.files"});if(this.context.instance.configurationType===m.c7.Disallowed)return r.createElement("div",{className:"text-center"},r.createElement(g.Z,{title:"view.instance.files.disallowed"}));const e=(0,w.H5)(this.context.instancePermissionSet,m.TI.List),t=(0,w.H5)(this.context.instancePermissionSet,m.TI.Write);return r.createElement("div",null,r.createElement(R.t,{obj:this.state}),r.createElement("h2",{className:"text-center"},r.createElement(h.Z,{id:"view.instance.files.file_browser"})),this.state.errors.map(((e,t)=>{if(e)return r.createElement(E.ZP,{key:t,error:e,onClose:()=>this.setState((e=>{const i=Array.from(e.errors);return i[t]=void 0,{errors:i}}))})})),r.createElement("div",{className:"d-flex flex-row"},e?r.createElement("div",{className:"text-left",style:{paddingRight:"16px",maxHeight:"800px",minWidth:"200px",overflowY:"scroll"}},this.renderDirectory(this.state.rootDirectory)):r.createElement("div",{style:{maxWidth:"200px"}},r.createElement(g.Z,{title:"view.instance.files.disallowed.directory"})),r.createElement("div",{className:"flex-fill flex-column text-center align-self-center",style:{padding:"16px"}},t?r.createElement(r.Fragment,null):r.createElement(g.Z,{title:"view.instance.files.disallowed.write"}),this.state.selectedCreateNode?this.renderCreate():this.state.selectedFile?this.renderSelectedFile():e?r.createElement("h4",null,r.createElement(h.Z,{id:"view.instance.files.select_item"})):this.renderBrowserlessForms())))}renderDirectory(e){const t=Math.max(e.fileResponse.path.lastIndexOf("\\"),e.fileResponse.path.lastIndexOf("/")),i=e===this.state.selectedFile;if(!e.fileResponse.isDirectory){const a=e.fileResponse.path.slice(t+1);return r.createElement("li",{className:"browser-li"},r.createElement(l.Z,{variant:i?"secondary":"primary",onClick:()=>{this.shortAsyncAction((()=>this.selectFile(e)))},className:"nowrap"},r.createElement(n.G,{icon:s.cwv}),"\xa0",a))}const a=e==this.state.rootDirectory?"Configuration":e.fileResponse.path.slice(t+1);return r.createElement("div",{className:"mb-2"},r.createElement(o.Z,null,r.createElement(l.Z,{variant:e.fullyLoaded?"primary":"secondary",onClick:()=>{e.fullyLoaded?(this.clearDirectory(e),this.forceUpdate()):this.shortAsyncAction((()=>this.loadDirectory(e)))}},r.createElement(n.G,{icon:e.fullyLoaded?s.Jvx:s.x58})),r.createElement(l.Z,{className:"nowrap",variant:i?"secondary":"primary",onClick:()=>{this.shortAsyncAction((()=>this.selectFile(e)))}},a)),r.createElement("ul",{className:"browser-ul"},e.children.map((e=>r.createElement("li",{key:e.fileResponse.path},this.renderDirectory(e))))))}renderCreate(){const e={entityName:{type:v.fS.String,name:"fields.instance.files.create.name",tooltip:"fields.instance.files.create.name.tip",defaultValue:""},isDirectory:{type:v.fS.Boolean,name:"fields.instance.files.create.directory",defaultValue:!1}},t=this.state.selectedCreateNode;return r.createElement(r.Fragment,null,r.createElement("h5",null,t.fileResponse.path,t.parent?"/":""),r.createElement("h5",null,r.createElement(h.Z,{id:"view.instance.files.create"})),r.createElement("hr",null),r.createElement(x.Z,{fields:e,onSave:e=>{this.createEntity(e,t)},saveMessageId:"fields.instance.files.create"}))}renderSelectedFile(){const e=(0,w.H5)(this.context.instancePermissionSet,m.TI.Read),t=(0,w.H5)(this.context.instancePermissionSet,m.TI.Write),i=this.state.selectedFile,a=Math.max(i.fileResponse.path.lastIndexOf("\\"),i.fileResponse.path.lastIndexOf("/")),o=i.fileResponse.path.slice(a+1),p=!i.fileResponse.isDirectory&&!i.fileResponse.lastReadHash,f=i==this.state.rootDirectory?"Configuration":i.fileResponse.path.slice(a+1),y=this.state.selectedCreateNode===i,u=(0,w.H5)(this.context.instancePermissionSet,m.TI.Delete);let E=i.fileResponse.path.replaceAll("\\","/");return E.startsWith("/")||(E="/"+E),r.createElement(r.Fragment,null,r.createElement("h5",null,E),r.createElement("hr",null),r.createElement("div",{className:"mb-3"},i.fileResponse.isDirectory?r.createElement(r.Fragment,null,r.createElement(l.Z,{variant:"primary",className:"mx-2 nowrap",onClick:()=>{this.downloadDirectory(i)}},r.createElement(n.G,{icon:s.q7m}),"\xa0",r.createElement(h.Z,{id:"view.instance.files.download.directory"})),r.createElement(l.Z,{variant:y?"secondary":"primary",className:"mx-2 nowrap",onClick:()=>{this.state.selectedCreateNode!=i&&this.setState({selectedCreateNode:i})}},r.createElement(n.G,{icon:s.gMD}),"\xa0",r.createElement(h.Z,{id:"view.instance.files.create"})),r.createElement(c.Z,{placement:"top",show:(!u||!i.fullyLoaded||0!==i.children.length)&&void 0,overlay:e=>r.createElement(d.Z,b({id:"cant-delete-dir-tooltip"},e),r.createElement(h.Z,{id:i.fullyLoaded?u?"view.instance.files.delete.directory.populated":"view.instance.files.disallowed.directory.delete":"view.instance.files.delete.directory.populated.unloaded"}))},r.createElement(l.Z,{variant:"danger",className:"mx-2 nowrap",disabled:!i.fullyLoaded||!u||i.children.length>0||i==this.state.rootDirectory,onClick:()=>{confirm(this.props.intl.formatMessage({id:"view.instance.files.delete.directory.confirm"},{directoryName:f}))&&this.shortAsyncAction((()=>this.deleteDirectory(i)))}},r.createElement(n.G,{icon:s.NBC}),"\xa0",r.createElement(h.Z,{id:"view.instance.files.delete.directory"})))):r.createElement(r.Fragment,null,r.createElement(c.Z,{placement:"top",overlay:e=>r.createElement(d.Z,b({id:"file-download-location-tooltip"},e),r.createElement(h.Z,{id:"view.instance.files.download.location"}))},r.createElement(l.Z,{className:"mx-2",disabled:!e,onClick:()=>{this.downloadFile()}},r.createElement(h.Z,{id:"view.instance.files.download"}))),r.createElement(c.Z,{placement:"top",show:!(!t||!p)&&void 0,overlay:e=>r.createElement(d.Z,b({id:"file-not-refreshed-tooltip"},e),r.createElement(h.Z,{id:"view.instance.files.replace.stale"}))},r.createElement(l.Z,{variant:"warning",className:"mx-2",disabled:!t||p,onClick:()=>{this.createEntity({entityName:o,isDirectory:!1,replace:!0},i)}},r.createElement(h.Z,{id:"view.instance.files.replace"}))),r.createElement(c.Z,{placement:"top",show:!(!t||!p)&&void 0,overlay:e=>r.createElement(d.Z,b({id:"file-not-refreshed-tooltip-delete"},e),r.createElement(h.Z,{id:"view.instance.files.replace.stale"}))},r.createElement(l.Z,{variant:"danger",className:"mx-2",disabled:!t||p,onClick:()=>{confirm(this.props.intl.formatMessage({id:"view.instance.files.delete.confirm"},{path:i.fileResponse.path}))&&this.shortAsyncAction((()=>this.deleteFile()))}},r.createElement(h.Z,{id:"view.instance.files.delete"}))))))}renderBrowserlessForms(){return r.createElement(D.Z,null)}}C.contextType=u.g,t.default=(0,p.ZP)(C)}}]);
//# sourceMappingURL=926.2b6fde11e3b30af7d977.bundle.js.map