"use strict";(self.webpackChunktgstation_server_control_panel=self.webpackChunktgstation_server_control_panel||[]).push([[740],{740:function(e,t,n){n.r(t);var a,i,s=n(1417),c=n(1436),l=n(7814),r=n(7294),o=n(5293),d=n(3489),h=n(5005),m=n(4012),p=n(4806),f=n(1767),u=n(8509),C=n(3803),g=n(6190),E=n(6964),S=n(9635),v=n(9049),y=n(5619),B=n(8425),w=n(5855);function x(){return x=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},x.apply(this,arguments)}!function(e){e[e.Always=0]="Always",e[e.OnError=1]="OnError",e[e.Never=2]="Never"}(a||(a={})),function(e){e[e.Server=0]="Server",e[e.SASL=1]="SASL",e[e.NickServ=2]="NickServ"}(i||(i={}));class b extends r.Component{constructor(e){super(e),this.state={loading:!0,errors:[],chatBots:[],selectedAddNode:!1,selectedChatBot:null,selectedChannel:null,addBotProvider:u.aM.Discord},this.renderChatBotBrowser=this.renderChatBotBrowser.bind(this)}async componentDidMount(){(0,E.$V)(this.context.instancePermissionSet,u.xr.Read)?await this.refresh():this.setState({loading:!1})}addError(e){this.setState((t=>{const n=Array.from(t.errors);return n.push(e),{errors:n}}))}async refresh(){if((0,E.$V)(this.context.instancePermissionSet,u.xr.Read)){this.setState({loading:!0});let e=1,t=[];for(let n=1;n<=e;++n){const a=await f.Z.listChatBots(this.context.instance.id,{page:n});if(a.code!==C.G.OK){this.addError(a.error);break}e=a.payload.totalPages,t=t.concat(a.payload.content)}t.forEach((e=>e.loadedWithConnectionString=!1)),this.setState({chatBots:t,loading:!1})}}async addChatBot(e){let t,n,a;if(!e.name)return void alert(this.props.intl.formatMessage({id:"view.instance.chat.create.missing.name"}));switch(e.provider){case u.aM.Discord:if(n=e,!n.botToken)return void alert(this.props.intl.formatMessage({id:"view.instance.chat.create.missing.token"}));t=`${n.botToken};${n.dmOutputDisplay};${n.basedMeme?"1":"0"}`;break;case u.aM.Irc:if(a=e,!a.address)return void alert(this.props.intl.formatMessage({id:"view.instance.chat.create.missing.address"}));if(!a.nickname)return void alert(this.props.intl.formatMessage({id:"view.instance.chat.create.missing.nick"}));t=`${a.address};${a.port};${a.nickname};${a.useSsl?"1":"0"}`,a.password&&(t+=`;${a.passwordType};${a.password}`);break;default:throw new Error("Bad provider!")}this.setState({loading:!0});const i=await f.Z.createChatBot(this.context.instance.id,{provider:e.provider,name:e.name,enabled:e.enabled,connectionString:t,channelLimit:e.channelLimit,reconnectionInterval:e.reconnectionInterval});if(i.code===C.G.OK){const e=i.payload;e.loadedWithConnectionString=!0;const t=[...this.state.chatBots];t.push(e),this.setState({chatBots:t,selectedChatBot:e,selectedAddNode:!1})}else this.addError(i.error);this.setState({loading:!1})}async reloadChatBot(e){this.setState({loading:!0});const t=await f.Z.getChatBot(this.context.instance.id,e.id);if(t.code===C.G.OK){(e=t.payload).loadedWithConnectionString=!0;const n=[...this.state.chatBots],a=n.indexOf(e);n[a]=e,this.setState({chatBots:n,selectedChatBot:e})}else this.addError(t.error);this.setState({loading:!1})}async editChatBot(e){this.setState({loading:!0});let t=this.state.selectedChatBot;const n=await f.Z.updateChatBot(this.context.instance.id,{...e,id:t.id});if(n.code===C.G.OK){if(n.payload){const e=[...this.state.chatBots],a=e.indexOf(t);t=n.payload,t.loadedWithConnectionString=!0,e[a]=t,this.setState({chatBots:e,selectedChatBot:t})}}else this.addError(n.error);this.setState({loading:!1})}async addChatChannel(e,t){if(!t.ircChannel)return void alert(this.props.intl.formatMessage({id:"view.instance.chat.create.missing.channel"}));if(e.provider===u.aM.Discord){if(!new RegExp("^[0-9]+$").test(t.ircChannel))return void alert(this.props.intl.formatMessage({id:"view.instance.chat.create.invalid.discord"}));t.discordChannelId=t.ircChannel,t.ircChannel=null}this.setState({loading:!0});const n=[...e.channels??[]];n.push(t);const a=await f.Z.updateChatBot(this.context.instance.id,{channels:n,id:e.id});if(a.code===C.G.OK){if(a.payload){const t=[...this.state.chatBots],n=t.indexOf(e);(e=a.payload).loadedWithConnectionString=!0,t[n]=e,this.setState({chatBots:t,selectedChatBot:e,selectedChannel:e.channels[e.channels.length-1]})}}else this.addError(a.error);this.setState({loading:!1})}async editChatChannel(e,t){this.setState({loading:!0});const n=[...e.channels??[]],a=n[n.indexOf(this.state.selectedChannel)];Object.assign(a,t);const i=await f.Z.updateChatBot(this.context.instance.id,{channels:n,id:e.id});if(i.code===C.G.OK){if(i.payload){const t=[...this.state.chatBots],n=t.indexOf(e);(e=i.payload).loadedWithConnectionString=!0,t[n]=e,this.setState({chatBots:t,selectedChatBot:e})}}else this.addError(i.error);this.setState({loading:!1})}async deleteChatChannel(e,t){if(!confirm(this.props.intl.formatMessage({id:"view.instance.chat.delete.channel.confirm"},{channelName:t.tag??t.ircChannel??t.discordChannelId})))return;this.setState({loading:!0});const n=[...e.channels??[]],a=n.indexOf(t);n.splice(a,1);const i=await f.Z.updateChatBot(this.context.instance.id,{channels:n,id:e.id});if(i.code===C.G.OK){if(i.payload){const t=[...this.state.chatBots],n=t.indexOf(e);(e=i.payload).loadedWithConnectionString=!0,t[n]=e,this.setState({chatBots:t,selectedChatBot:e,selectedChannel:null})}}else this.addError(i.error);this.setState({loading:!1})}async deleteChatBot(e){if(!confirm(this.props.intl.formatMessage({id:"view.instance.chat.delete.confirm"},{botName:e.name})))return;this.setState({loading:!0});const t=await f.Z.deleteChatBot(this.context.instance.id,e.id);if(t.code===C.G.OK){const t=[...this.state.chatBots],n=t.indexOf(e);t.splice(n,1),this.setState({chatBots:t,selectedChatBot:null})}else this.addError(t.error);this.setState({loading:!1})}render(){if(this.state.loading)return r.createElement(w.Z,{text:"loading.chat"});const e=(0,E.$V)(this.context.instancePermissionSet,u.xr.Read),t=(0,E.$V)(this.context.instancePermissionSet,u.xr.Create);return r.createElement("div",{className:"text-center"},r.createElement(B.t,{obj:this.state}),r.createElement("h1",null,r.createElement(m.Z,{id:"view.instance.chat"})),r.createElement("div",{className:"d-flex flex-row"},r.createElement("div",{className:"text-left",style:{paddingRight:"16px",maxHeight:"800px",minWidth:"300px",overflowY:"scroll"}},r.createElement("ul",{className:"browser-ul"},e?this.state.chatBots.map(this.renderChatBotBrowser):r.createElement(r.Fragment,null),t?r.createElement("li",{className:"browser-li"},r.createElement(o.Z,{placement:"top",show:!(this.state.chatBots.length<this.context.instance.chatBotLimit)&&void 0,overlay:e=>r.createElement(d.Z,x({id:"too-many-chat-bots"},e),r.createElement(m.Z,{id:"view.instance.chat.limit",values:{max:this.context.instance.chatBotLimit}}))},r.createElement(h.Z,{className:"nowrap",disabled:this.state.chatBots.length>=this.context.instance.chatBotLimit,onClick:()=>this.setState({selectedChatBot:null,selectedChannel:null,selectedAddNode:!(this.state.selectedAddNode&&!this.state.selectedChatBot)})},r.createElement(l.G,{icon:c.r8p}),"\xa0",r.createElement(m.Z,{id:"view.instance.chat.create"})))):r.createElement(r.Fragment,null))),r.createElement("div",{className:"flex-fill flex-column text-center align-self-center",style:{padding:"16px"}},this.state.selectedChannel?this.renderAddEditChannel(!1):this.state.selectedChatBot&&!this.state.selectedAddNode?this.renderAddEditChatBot(!1):this.state.selectedAddNode?this.state.selectedChatBot?this.renderAddEditChannel(!0):this.renderAddEditChatBot(!0):r.createElement("h4",null,r.createElement(m.Z,{id:"view.instance.chat.select_item"})))))}renderChatBotBrowser(e){const t=this.state.selectedChatBot===e,n=(0,E.$V)(this.context.instancePermissionSet,u.xr.WriteChannels);return r.createElement("li",{key:e.id,className:"browser-li"},r.createElement(h.Z,{variant:t?"secondary":"primary",onClick:()=>this.setState({selectedChatBot:t&&!this.state.selectedAddNode?null:e,selectedChannel:null,selectedAddNode:!1}),className:"nowrap"},r.createElement(l.G,{icon:e.provider===u.aM.Discord?s.omb:c.Mzg}),"\xa0",e.name),n&&t?r.createElement("ul",{className:"browser-ul"},e.channels.map((e=>{const t=this.state.selectedChannel===e;return r.createElement("li",{key:e.discordChannelId??e.ircChannel,className:"browser-li"},r.createElement(h.Z,{variant:t?"secondary":"primary",onClick:()=>this.setState({selectedChannel:t?null:e}),className:"nowrap"},r.createElement(l.G,{icon:c.olY}),"\xa0",e.tag?`(${e.tag})`:e.discordChannelId??e.ircChannel))})),r.createElement("li",{className:"browser-li"},r.createElement(o.Z,{placement:"top",show:!(e.channels.length<e.channelLimit)&&void 0,overlay:t=>r.createElement(d.Z,x({id:"too-many-chat-channels"},t),r.createElement(m.Z,{id:"view.instance.chat.limit.channels",values:{max:e.channelLimit}}))},r.createElement(h.Z,{className:"nowrap",disabled:e.channels.length>=e.channelLimit,onClick:()=>this.setState({selectedChannel:null,selectedAddNode:!(this.state.selectedAddNode&&!this.state.selectedChannel)})},r.createElement(l.G,{icon:c.r8p}),"\xa0",r.createElement(m.Z,{id:"view.instance.chat.create.channel"}))))):r.createElement(r.Fragment,null))}renderAddEditChatBot(e){const t={type:v.fS.Enum,name:"fields.instance.chat.provider",defaultValue:this.state.addBotProvider,enum:u.aM,noLocalize:!0},n={...t,onChange:e=>{this.setState({addBotProvider:e})}},p={provider:{...t},name:{type:v.fS.String,name:"fields.instance.chat.name",tooltip:"fields.instance.chat.name.tip"},enabled:{type:v.fS.Boolean,name:"fields.instance.chat.enabled",tooltip:"fields.instance.chat.enabled.tip",defaultValue:!0},channelLimit:{type:v.fS.Number,name:"fields.instance.chat.limit",tooltip:"fields.instance.chat.limit.tip",min:0,max:65535,defaultValue:10},reconnectionInterval:{type:v.fS.Number,name:"fields.instance.chat.reconnect",tooltip:"fields.instance.chat.reconnect.tip",min:0,defaultValue:5}};if(e){const e={...p,botToken:{type:v.fS.String,name:"fields.instance.chat.create.discord.token",tooltip:"fields.instance.chat.create.discord.token.tip"},dmOutputDisplayType:{type:v.fS.Enum,name:"fields.instance.chat.create.discord.output",tooltip:"fields.instance.chat.create.discord.output.tip",defaultValue:a.Always,enum:a,noLocalize:!0},basedMeme:{type:v.fS.Boolean,name:"fields.instance.chat.create.discord.based",tooltip:"fields.instance.chat.create.discord.based.tip",defaultValue:!0}},t={...p,address:{type:v.fS.String,name:"fields.instance.chat.create.irc.address",tooltip:"fields.instance.chat.create.irc.address.tip"},port:{type:v.fS.Number,name:"fields.instance.chat.create.irc.port",min:1,max:65535,defaultValue:6697},nickname:{type:v.fS.String,name:"fields.instance.chat.create.irc.nick"},password:{type:v.fS.Password,name:"fields.instance.chat.create.irc.pass",tooltip:"fields.instance.chat.create.irc.pass.tip"},passwordType:{type:v.fS.Enum,name:"fields.instance.chat.create.irc.passtype",defaultValue:i.SASL,enum:i,noLocalize:!0},useSsl:{type:v.fS.Boolean,name:"fields.instance.chat.create.irc.ssl",tooltip:"fields.instance.chat.create.irc.ssl.tip"}};return p.provider.disabled=!0,r.createElement(r.Fragment,null,r.createElement("h5",null,r.createElement(m.Z,{id:"view.instance.chat.create"})),r.createElement("hr",null),r.createElement(v.ZP,n),r.createElement("hr",null),r.createElement(y.Z,{key:`bot-create-form-${this.state.addBotProvider}`,hideDisabled:!0,includeAll:!0,saveMessageId:"fields.instance.chat.create.save",fields:this.state.addBotProvider===u.aM.Discord?e:t,onSave:e=>{this.addChatBot(e)}}))}const f=this.state.selectedChatBot,C=(0,E.$V)(this.context.instancePermissionSet,u.xr.ReadConnectionString),g=(0,E.$V)(this.context.instancePermissionSet,u.xr.WriteConnectionString),S={...p,connectionString:{type:v.fS.String,name:"fields.instance.chat.edit.connection",tooltip:"fields.instance.chat.edit.connection.tip",defaultValue:C?f.loadedWithConnectionString?f.connectionString:this.props.intl.formatMessage({id:"fields.instance.chat.edit.connection.unloaded"}):this.props.intl.formatMessage({id:"fields.instance.chat.edit.connection.deny"}),disabled:!g}};S.name.defaultValue=f.name,S.enabled.defaultValue=f.enabled,S.channelLimit.defaultValue=f.channelLimit,S.reconnectionInterval.defaultValue=f.reconnectionInterval,S.name.disabled=!(0,E.$V)(this.context.instancePermissionSet,u.xr.WriteName),S.enabled.disabled=!(0,E.$V)(this.context.instancePermissionSet,u.xr.WriteEnabled),S.channelLimit.disabled=!(0,E.$V)(this.context.instancePermissionSet,u.xr.WriteChannelLimit),S.reconnectionInterval.disabled=!(0,E.$V)(this.context.instancePermissionSet,u.xr.WriteReconnectionInterval);const B=(0,E.$V)(this.context.instancePermissionSet,u.xr.Delete);return r.createElement(r.Fragment,null,r.createElement("h5",null,r.createElement(l.G,{icon:f.provider===u.aM.Discord?s.omb:c.Mzg}),"\xa0",f.name),r.createElement("hr",null),f.loadedWithConnectionString?r.createElement(r.Fragment,null):r.createElement(r.Fragment,null,r.createElement(o.Z,{placement:"top",show:!C&&void 0,overlay:e=>r.createElement(d.Z,x({id:"chat-bot-read-conn-perm"},e),r.createElement(m.Z,{id:"view.instance.chat.reload.deny"}))},r.createElement(h.Z,{className:"nowrap",disabled:!C,onClick:()=>{this.reloadChatBot(f)}},r.createElement(m.Z,{id:"view.instance.chat.reload"}))),r.createElement("br",null),r.createElement("br",null)),r.createElement(y.Z,{fields:S,onSave:e=>{this.editChatBot(e)}}),r.createElement("hr",null),r.createElement(o.Z,{placement:"top",show:!B&&void 0,overlay:e=>r.createElement(d.Z,x({id:"chat-bot-delete-perm"},e),r.createElement(m.Z,{id:"view.instance.chat.delete.deny"}))},r.createElement(h.Z,{className:"nowrap",disabled:!B,variant:"danger",onClick:()=>{this.deleteChatBot(f)}},r.createElement(m.Z,{id:"view.instance.chat.delete"}))))}renderAddEditChannel(e){const t=this.state.selectedChatBot,n={tag:{type:v.fS.String,name:"fields.instance.chat.channel.tag",tooltip:"fields.instance.chat.channel.tag.tip"},isAdminChannel:{type:v.fS.Boolean,name:"fields.instance.chat.channel.admin",tooltip:"fields.instance.chat.channel.admin.tip"},isWatchdogChannel:{type:v.fS.Boolean,name:"fields.instance.chat.channel.watchdog",tooltip:"fields.instance.chat.channel.watchdog.tip"},isUpdatesChannel:{type:v.fS.Boolean,name:"fields.instance.chat.channel.updates",tooltip:"fields.instance.chat.channel.updates.tip"}},a=(0,E.$V)(this.context.instancePermissionSet,u.xr.WriteChannels);if(e){const e={ircChannel:{type:v.fS.String,name:"fields.instance.chat.channel.discord",tooltip:"fields.instance.chat.channel.discord.tip"},...n},a={ircChannel:{type:v.fS.String,name:"fields.instance.chat.channel.irc",tooltip:"fields.instance.chat.channel.irc.tip",defaultValue:"#"},...n};return r.createElement(r.Fragment,null,r.createElement("h5",null,r.createElement(m.Z,{id:"view.instance.chat.create.channel"})),r.createElement("hr",null),r.createElement(y.Z,{key:`bot-channel-create-form-${t.provider}`,includeAll:!0,saveMessageId:"fields.instance.chat.create.channel",fields:t.provider===u.aM.Discord?e:a,onSave:e=>{this.addChatChannel(t,e)}}))}const i=this.state.selectedChannel;return n.isAdminChannel.defaultValue=i.isAdminChannel,n.isUpdatesChannel.defaultValue=i.isUpdatesChannel,n.isWatchdogChannel.defaultValue=i.isWatchdogChannel,n.tag.defaultValue=i.tag,r.createElement(r.Fragment,{key:t.channels.indexOf(i)},i.discordChannelId?r.createElement(S.Z,{title:"view.instance.chat.channel.wrong_id"}):r.createElement(r.Fragment,null),r.createElement("h5",null,i.ircChannel??i.discordChannelId,i.tag?` (${i.tag})`:""),r.createElement("hr",null),r.createElement(y.Z,{fields:n,onSave:e=>{this.editChatChannel(t,e)}}),r.createElement("hr",null),r.createElement(o.Z,{placement:"top",show:!a&&void 0,overlay:e=>r.createElement(d.Z,x({id:"chat-bot-delete-perm"},e),r.createElement(m.Z,{id:"view.instance.chat.delete.channel.deny"}))},r.createElement(h.Z,{className:"nowrap",disabled:!a,variant:"danger",onClick:()=>{this.deleteChatChannel(t,i)}},r.createElement(m.Z,{id:"view.instance.chat.delete.channel"}))))}}b.contextType=g.g,t.default=(0,p.ZP)(b)}}]);
//# sourceMappingURL=740.1a5984976904495cf0e1.bundle.js.map