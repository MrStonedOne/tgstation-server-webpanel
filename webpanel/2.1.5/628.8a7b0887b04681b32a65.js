(self.webpackChunktgstation_server_control_panel=self.webpackChunktgstation_server_control_panel||[]).push([[628],{98628:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return Q}});var r=n(67294),o=n(35005),i=n(31555),a=n(94716),c=n(62318),u=n(86828),s=n(43489),l=n(44012),f=n(30724),d=n.n(f),p=n(41153),v=n(34820),h=n(36800),y=n(38592),m=n(65022),b=n(69644),w=n(32826),g=n(6964),E=n(17347),O=n(24516),k=n(12527),S=n(7205),Z=n(2486);function R(e){return(R="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function j(e,t){return(j=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function P(e,t){return!t||"object"!==R(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function x(e){return(x=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function C(e,t,n,r,o,i,a){try{var c=e[i](a),u=c.value}catch(e){return void n(e)}c.done?t(u):Promise.resolve(u).then(r,o)}function A(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function a(e){C(i,r,o,a,c,"next",e)}function c(e){C(i,r,o,a,c,"throw",e)}a(void 0)}))}}function L(e,t,n){return I.apply(this,arguments)}function I(){return(I=A((function*(e,t,n){var r=e.endpoint.merge(t,n);return S.Z.githubtoken.value&&(r.headers.authorization="token ".concat(S.Z.githubtoken.value)),e(r)}))).apply(this,arguments)}function N(){return G.apply(this,arguments)}function G(){return(G=A((function*(){return S.Z.githubtoken.value?{type:"token",tokenType:"pat",token:S.Z.githubtoken.value}:{type:"unauthenticated"}}))).apply(this,arguments)}var V=function(){return Object.assign(N.bind(null),{hook:L.bind(null)})},T=new(function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&j(e,t)}(c,e);var t,n,r,o,i,a=(o=c,i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=x(o);if(i){var n=x(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return P(this,e)});function c(){var e;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,c),(e=a.call(this)).apiClient=void 0;var t=O.v.plugin(g.X,E.O);return e.apiClient=new t({authStrategy:V,userAgent:"tgstation-server-control-panel/"+Z.q4,baseUrl:"https://api.github.com",throttle:{onRateLimit:function(e,t){return console.warn("Request quota exhausted for request ".concat(t.method," ").concat(t.url)),0===t.request.retryCount&&(console.log("Retrying after ".concat(e," seconds!")),!0)},onAbuseLimit:function(e,t){console.warn("Abuse detected for request ".concat(t.method," ").concat(t.url))}}}),e}return t=c,(n=[{key:"getVersions",value:(r=A((function*(e){var t,n=e.owner,r=e.repo,o=e.current,i=e.all,a=0;try{t=yield this.apiClient.paginate(this.apiClient.repos.listReleases,{owner:n,repo:r},(function(e,t){return e.data.reduce((function(e,n){var r,c,u=/tgstation-server-v([\d.]+)/.exec(null!==(r=n.name)&&void 0!==r?r:"");if(!u)return e;if("4"!==u[1][0])return e;var s=u[1],l=!1;if(s<=o){if(a>=3&&!i)return t(),e;a++,l=!0}return e.push({version:s,body:null!==(c=n.body)&&void 0!==c?c:"",current:s===o,old:l}),e}),[])}))}catch(e){return new y.Z({code:y.G.ERROR,error:new h.ZP(h.jK.GITHUB_FAIL,{jsError:e})})}return new y.Z({code:y.G.OK,payload:t})})),function(e){return r.apply(this,arguments)})}])&&_(t.prototype,n),c}(k.TypedEmitter)),U=n(3429),q=n(43307),K=n(71739);function B(e){return(B="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function F(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function $(e,t,n,r,o,i,a){try{var c=e[i](a),u=c.value}catch(e){return void n(e)}c.done?t(u):Promise.resolve(u).then(r,o)}function M(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function a(e){$(i,r,o,a,c,"next",e)}function c(e){$(i,r,o,a,c,"throw",e)}a(void 0)}))}}function z(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function D(e,t){return(D=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function H(e,t){return!t||"object"!==B(t)&&"function"!=typeof t?W(e):t}function W(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function X(e){return(X=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var J=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&D(e,t)}(k,e);var t,n,f,p,w,g,E,O=(g=k,E=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=X(g);if(E){var n=X(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return H(this,e)});function k(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,k),(t=O.call(this,e)).loadNotes=t.loadNotes.bind(W(t)),t.updateServer=t.updateServer.bind(W(t)),t.state={versions:[],errors:[],loading:!0},t}return t=k,(n=[{key:"componentDidMount",value:(w=M((function*(){var e=[];e.push(this.loadVersions()),yield Promise.all(e),this.setState({loading:!1})})),function(){return w.apply(this,arguments)})},{key:"componentWillUnmount",value:function(){this.state.timer&&window.clearInterval(this.state.timer)}},{key:"addError",value:function(e){this.setState((function(t){var n=Array.from(t.errors);return n.push(e),{errors:n}}))}},{key:"loadVersions",value:(p=M((function*(){var e=yield v.Z.getAdminInfo();switch(e.code){case y.G.ERROR:return this.addError(e.error);case y.G.OK:var t=e.payload.trackedRepositoryUrl,n=/https?:\/\/(github\.com)\/(.*?)\/(.*)/.exec(t);if(!n)return this.addError(new h.ZP(h.jK.APP_FAIL,{jsError:Error("Unknown repository url format: ".concat(t))}));if("github.com"!==n[1])return void this.setState({versions:[{body:"Updates unavailable to non github repos",version:"Updates unavailable to non github repos",current:!0,old:!0}]});var r=yield T.getVersions({owner:n[2],repo:n[3],current:this.context.serverInfo.version,all:!!this.props.match.params.all});switch(console.log("Version info: ",r),r.code){case y.G.ERROR:return this.addError(r.error);case y.G.OK:this.setState({versions:r.payload})}}})),function(){return p.apply(this,arguments)})},{key:"loadNotes",value:function(){var e,t=this,n=function(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return F(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?F(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,c=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return a=e.done,e},e:function(e){c=!0,i=e},f:function(){try{a||null==n.return||n.return()}finally{if(c)throw i}}}}(this.state.versions);try{for(n.s();!(e=n.n()).done;){var r=e.value;if(r.version===this.state.selectedOption){var o=window.setInterval((function(){t.setState((function(e){return void 0===e.secondsLeft||null===e.secondsLeft?e:1===e.secondsLeft?(window.clearInterval(e.timer),{timer:null,secondsLeft:null}):{secondsLeft:e.secondsLeft-1}}))}),1e3);return void this.setState({selectedVersion:r,timer:o,secondsLeft:10})}}}catch(e){n.e(e)}finally{n.f()}}},{key:"updateServer",value:(f=M((function*(){if(!this.state.selectedOption)return console.error("Attempted to update server to a no version"),void this.setState({selectedVersion:void 0});var e=yield v.Z.updateServer(this.state.selectedOption);switch(e.code){case y.G.ERROR:this.addError(e.error);break;case y.G.OK:m.Z.autoLogin=!1,window.setInterval(M((function*(){switch((yield b.Z.getCurrentUser(!0)).code){case y.G.ERROR:window.location.reload()}})),2e3),this.setState({updating:!0})}})),function(){return f.apply(this,arguments)})},{key:"render",value:function(){var e=this;if(this.state.updating)return r.createElement(K.Z,{text:"loading.updating"});if(this.state.loading)return r.createElement(K.Z,{text:"loading.version"});var t=function(t){e.setState({selectedOption:t.target.value})},n="number"==typeof this.state.secondsLeft;return r.createElement(r.Fragment,null,r.createElement("div",{className:"text-center"},this.state.errors.map((function(t,n){if(t)return r.createElement(q.Z,{key:n,error:t,onClose:function(){return e.setState((function(e){var t=Array.from(e.errors);return t[n]=void 0,{errors:t}}))}})}))),this.state.selectedVersion?r.createElement(r.Fragment,null,r.createElement("div",{className:"text-center"},r.createElement(o.Z,{className:"mr-3",onClick:function(){return e.setState({selectedVersion:void 0})}},r.createElement(l.Z,{id:"generic.goback"})),r.createElement(u.Z,{overlay:r.createElement(s.Z,{id:"timing-tooltip"},r.createElement(l.Z,{id:"view.admin.update.wait"})),show:n},r.createElement(o.Z,{onClick:this.updateServer,disabled:n},r.createElement(l.Z,{id:"generic.continue"}),n?" [".concat(this.state.secondsLeft,"]"):"")),r.createElement("h3",null,r.createElement(l.Z,{id:"view.admin.update.releasenotes"})),r.createElement("hr",null)),r.createElement(d(),{source:this.state.selectedVersion.body})):r.createElement("div",{className:"text-center"},r.createElement("h3",{className:"mb-4"},r.createElement(l.Z,{id:"view.admin.update.selectversion"})),r.createElement(i.Z,{xs:8,md:6,className:"mx-auto"},this.state.versions.map((function(n,o){return r.createElement(c.Z,{className:"mb-3",key:n.version},r.createElement(c.Z.Prepend,null,r.createElement(c.Z.Radio,{id:n.version,name:"version",disabled:n.current,value:n.version,checked:e.state.selectedOption===n.version,onChange:t})),r.createElement(a.Z,{as:"label",htmlFor:n.version,disabled:!0},n.version,n.current?r.createElement(l.Z,{id:"view.admin.update.current"}):"",0==o?r.createElement(l.Z,{id:"view.admin.update.latest"}):""))})),r.createElement(o.Z,{variant:"link",onClick:function(){var t;e.props.history.push((null!==(t=U.$w.admin_update.link)&&void 0!==t?t:U.$w.admin_update.route)+"all/",{reload:!0})},disabled:!!this.props.match.params.all},r.createElement(l.Z,{id:"view.admin.update.showall"})),r.createElement("br",null),r.createElement(o.Z,{onClick:this.loadNotes,disabled:!this.state.selectedOption},r.createElement(l.Z,{id:"generic.continue"})))))}}])&&z(t.prototype,n),k}(r.Component);J.contextType=w.f;var Q=(0,p.EN)(J)}}]);
//# sourceMappingURL=628.8a7b0887b04681b32a65.js.map