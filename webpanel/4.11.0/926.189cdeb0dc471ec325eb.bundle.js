"use strict";(self.webpackChunktgstation_server_control_panel=self.webpackChunktgstation_server_control_panel||[]).push([[926],{6642:function(e,t,i){i.d(t,{Z:function(){return r}});var s=i(7294),n=i(5881),a=i(4012),l=i(6755);class r extends s.Component{render(){return s.createElement(n.Z,{className:"bg-transparent",border:"info"},s.createElement(n.Z.Header,{className:"bg-info text-dark font-weight-bold"},s.createElement(a.Z,{id:"generic.wip"})),s.createElement(n.Z.Body,null,s.createElement(n.Z.Title,null,s.createElement(a.Z,{id:"generic.wip.desc"}),s.createElement("a",{href:"https://github.com/tgstation/Tgstation.Server.ControlPanel/releases/latest"},"https://github.com/tgstation/Tgstation.Server.ControlPanel/releases/latest")),s.createElement(n.Z.Text,{as:"pre",className:"bg-transparent text-info"},s.createElement("code",null,`Version: ${l.q4}\nWebpanel Mode: ${l.IK}\nCurrent route: ${window.location.toString()}`))))}}},926:function(e,t,i){i.r(t);var s=i(1436),n=i(7814),a=i(8256),l=i(7294),r=i(5005),o=i(5293),c=i(3489),d=i(4012),h=i(4806),p=i(3637),m=i(8509),f=i(3803),y=i(6190),u=i(6964),w=i(3e3),E=i(9635),g=i(9049),v=i(5619),x=i(8425),R=i(5855),Z=i(6642);function b(){return b=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(e[s]=i[s])}return e},b.apply(this,arguments)}const D=(e,t)=>{const i=window.navigator;if(i&&i.msSaveOrOpenBlob)i.msSaveOrOpenBlob(t,e);else{const i=document.createElement("a");document.body.appendChild(i);const s=URL.createObjectURL(t);i.href=s,i.download=e,i.click(),URL.revokeObjectURL(i.href),i.remove()}};class F{constructor(e,t){this.parent=void 0,this.children=void 0,this.fileResponse=void 0,this.totalFiles=void 0,this.fullyLoaded=!1,this.fileResponse=e,this.parent=t??null,e.isDirectory||(this.fullyLoaded=!0),this.children=[]}}class S extends l.Component{constructor(e){super(e),this.state={errors:[],rootDirectory:null,loading:!0,selectedFile:null,selectedCreateNode:null},this.createEntity=this.createEntity.bind(this),this.selectFile=this.selectFile.bind(this),this.shortAsyncAction=this.shortAsyncAction.bind(this),this.deleteFile=this.deleteFile.bind(this),this.loadDirectory=this.loadDirectory.bind(this),this.clearDirectory=this.clearDirectory.bind(this)}addError(e){this.setState((t=>{const i=Array.from(t.errors);return i.push(e),{errors:i}}))}async componentDidMount(){await this.loadRootDir()}async loadRootDir(){if((0,u.H5)(this.context.instancePermissionSet,m.TI.List)){this.setState({loading:!0});const e=new F({path:"/",isDirectory:!0,fileTicket:""});await this.loadDirectory(e),this.setState({rootDirectory:e,loading:!1})}else this.setState({loading:!1})}async shortAsyncAction(e){const t=e();let i=!1;const s=new Promise((e=>setTimeout(e,750))).then((()=>{i=!0}));await Promise.race([t,s]),i?(this.setState({loading:!0}),await t,this.setState({loading:!1})):this.forceUpdate()}async deleteDirectory(e){const t=await p.Z.deleteDirectory(this.context.instance.id,{path:e.fileResponse.path});if(t.code===f.G.OK){if(null!=e.parent){const t=e.parent.children.indexOf(e);e.parent.children.splice(t,1),this.forceUpdate()}}else this.addError(t.error)}async loadDirectory(e){if((0,u.H5)(this.context.instancePermissionSet,m.TI.List)){this.clearDirectory(e);const t="\\"===e.fileResponse.path[0]||"/"===e.fileResponse.path[0]?e.fileResponse.path.slice(1):e.fileResponse.path;let i=1;for(let s=1;s<=i;++s){const n=await p.Z.getDirectory(this.context.instance.id,t,{page:s});if(n.code!==f.G.OK){this.addError(n.error);break}{i=n.payload.totalPages,i<=s&&(e.fullyLoaded=!0);const t=n.payload.content.map((t=>new F(t,e)));for(const i of t)e.children.push(i)}}e.children=e.children.sort().reverse().sort(((e,t)=>t.fileResponse.isDirectory?1:0))}}async selectFile(e){if(this.state.selectedFile===e)return void this.setState({selectedFile:null});let t=e.fileResponse.path;for(;t.startsWith("/");)t=t.substring(1);const i=await p.Z.getConfigFile(this.context.instance.id,t,!1);i.code===f.G.OK?e.fileResponse=i.payload:(this.addError(i.error),e.fileResponse.lastReadHash=null),this.setState({selectedFile:e,selectedCreateNode:null})}async deleteFile(){const e=this.state.selectedFile,t=await p.Z.writeConfigFile(this.context.instance.id,{path:e.fileResponse.path,lastReadHash:e.fileResponse.lastReadHash},new Uint8Array);if(t.code===f.G.OK){const t=e.parent,i=t.children.indexOf(e);t.children.splice(i,1),this.setState({selectedFile:null})}else this.addError(t.error)}async downloadDirectory(e){this.setState({loading:!0});const t=async e=>{let t=[],i=1;const s="\\"===e.path[0]||"/"===e.path[0]?e.path.slice(1):e.path;for(let e=1;e<=i;++e){const n=await p.Z.getDirectory(this.context.instance.id,s,{page:e});if(n.code!==f.G.OK)return this.addError(n.error),null;i=n.payload.totalPages,t=t.concat(n.payload.content)}return t};let i=!1;const s=async t=>{const s=await p.Z.getConfigFile(this.context.instance.id,t.path,!0),n=t.path.substring(e.fileResponse.path.length);if(s.code===f.G.OK){const e=s.payload;return new File([e.content],n)}return this.addError(s.error),i=!0,null};let n=[e.fileResponse];const l=[];for(;n.length>0;){const e=[];if(n.forEach((i=>e.push(t(i)))),n=[],await Promise.all(e),i)return void this.setState({loading:!1});for(const t of e){const e=await t;if(null==e)return void this.setState({loading:!1});e.forEach((e=>{e.isDirectory?n.push(e):l.push(s(e))}))}}if(await Promise.all(l),i)return void this.setState({loading:!1});const r=[];for(const e of l)r.push(await e);const o=await(0,a.RZ)(r).blob(),c=Math.max(e.fileResponse.path.lastIndexOf("\\"),e.fileResponse.path.lastIndexOf("/")),d=e.fileResponse.path.slice(c+1);D(d,o),this.setState({loading:!1})}async downloadFile(){this.setState({loading:!0});const e=this.state.selectedFile,t=await p.Z.getConfigFile(this.context.instance.id,e.fileResponse.path,!0);if(t.code===f.G.OK){const i=Math.max(e.fileResponse.path.lastIndexOf("\\"),e.fileResponse.path.lastIndexOf("/")),s=e.fileResponse.path.slice(i+1);D(s,t.payload.content)}else this.addError(t.error);this.setState({loading:!1})}async createEntity(e,t){let i;if(e.isDirectory)i=new Uint8Array;else{const e=new Promise((e=>{const t=document.createElement("input");t.type="file",t.onchange=t=>{const i=t.target?.files;e(i?i[0]:null)},t.click()})),t=await e;if(!t)return;i=await t.arrayBuffer()}this.setState({loading:!0});let s=t.fileResponse.path;e.replace?s="/"+s:s+="/"+e.entityName,s.startsWith("//")&&(s=s.substring(1)),e.isDirectory&&(s+="/webpanel.dir.create.tmp");const n=await p.Z.writeConfigFile(this.context.instance.id,{path:s,lastReadHash:e.replace?t.fileResponse.lastReadHash:null},i);n.code!==f.G.OK?this.addError(n.error):e.replace&&(t.fileResponse=n.payload),e.replace||(t.fullyLoaded=!1,await this.loadDirectory(t));let a=s.replace("\\","/");a.startsWith("/")&&(a=a.substring(1));const l=t.children.find((e=>a.startsWith(e.fileResponse.path.replace("\\","/"))))??null;l&&(e.isDirectory?(await this.loadDirectory(l),this.setState({selectedCreateNode:null,selectedFile:null})):await this.selectFile(l)),this.setState({loading:!1})}clearDirectory(e){e.fullyLoaded=!1,e.children.forEach((e=>{e===this.state.selectedFile?this.setState({selectedFile:null}):e===this.state.selectedCreateNode&&this.setState({selectedCreateNode:null}),e.fileResponse.isDirectory&&this.clearDirectory(e)})),e.children=[]}render(){if(this.state.loading)return l.createElement(R.Z,{text:"loading.instance.files"});if(this.context.instance.configurationType===m.c7.Disallowed)return l.createElement("div",{className:"text-center"},l.createElement(E.Z,{title:"view.instance.files.disallowed"}));const e=(0,u.H5)(this.context.instancePermissionSet,m.TI.List),t=(0,u.H5)(this.context.instancePermissionSet,m.TI.Write);return l.createElement("div",null,l.createElement(x.t,{obj:this.state}),l.createElement("h2",{className:"text-center"},l.createElement(d.Z,{id:"view.instance.files.file_browser"})),this.state.errors.map(((e,t)=>{if(e)return l.createElement(w.ZP,{key:t,error:e,onClose:()=>this.setState((e=>{const i=Array.from(e.errors);return i[t]=void 0,{errors:i}}))})})),l.createElement("div",{className:"d-flex flex-row"},e?l.createElement("div",{className:"text-left",style:{paddingRight:"16px",maxHeight:"800px",minWidth:"200px",overflowY:"scroll"}},l.createElement("ul",{className:"browser-ul"},this.renderDirectory(this.state.rootDirectory))):l.createElement("div",{style:{maxWidth:"200px"}},l.createElement(E.Z,{title:"view.instance.files.disallowed.directory"})),l.createElement("div",{className:"flex-fill flex-column text-center align-self-center",style:{padding:"16px"}},t?l.createElement(l.Fragment,null):l.createElement(E.Z,{title:"view.instance.files.disallowed.write"}),this.state.selectedCreateNode?this.renderCreate():this.state.selectedFile?this.renderSelectedFile():e?l.createElement("h4",null,l.createElement(d.Z,{id:"view.instance.files.select_item"})):this.renderBrowserlessForms())))}renderDirectory(e){const t=Math.max(e.fileResponse.path.lastIndexOf("\\"),e.fileResponse.path.lastIndexOf("/"));if(!e.fileResponse.isDirectory){const i=e===this.state.selectedFile,a=e.fileResponse.path.slice(t+1);return l.createElement("li",{className:"browser-li"},l.createElement(r.Z,{variant:i?"secondary":"primary",onClick:()=>{this.shortAsyncAction((()=>this.selectFile(e)))},className:"nowrap"},l.createElement(n.G,{icon:s.cwv}),"\xa0",a))}const i=e==this.state.rootDirectory?"Configuration":e.fileResponse.path.slice(t+1),a=this.state.selectedCreateNode===e,h=(0,u.H5)(this.context.instancePermissionSet,m.TI.Delete);return l.createElement(l.Fragment,null,l.createElement("li",{className:"browser-li"},e.fullyLoaded?l.createElement(r.Z,{className:"nowrap",variant:"secondary",onClick:()=>{this.clearDirectory(e),this.forceUpdate()}},l.createElement(n.G,{icon:s.Jvx}),"\xa0",i):l.createElement(r.Z,{className:"nowrap",onClick:()=>{this.shortAsyncAction((()=>this.loadDirectory(e)))}},l.createElement(n.G,{icon:s.x58}),"\xa0",i)),l.createElement("ul",{className:"browser-ul"},e.children.length>0?l.createElement("li",{className:"browser-li"},l.createElement(r.Z,{variant:"primary",onClick:()=>{this.downloadDirectory(e)},className:"nowrap"},l.createElement(n.G,{icon:s.q7m}),"\xa0",l.createElement(d.Z,{id:"view.instance.files.download.directory"}))):null,e.children.map((e=>l.createElement(l.Fragment,{key:e.fileResponse.path},this.renderDirectory(e)))),e.fullyLoaded?l.createElement(l.Fragment,null,l.createElement("li",{className:"browser-li"},l.createElement(r.Z,{variant:a?"secondary":"primary",onClick:()=>{this.state.selectedCreateNode!=e&&this.setState({selectedCreateNode:e})},className:"nowrap"},l.createElement(n.G,{icon:s.gMD}),"\xa0(",l.createElement(d.Z,{id:"view.instance.files.create"}),")")),e.parent?l.createElement("li",{className:"browser-li"},l.createElement(o.Z,{placement:"top",show:(!h||0!==e.children.length)&&void 0,overlay:e=>l.createElement(c.Z,b({id:"cant-delete-dir-tooltip"},e),l.createElement(d.Z,{id:h?"view.instance.files.delete.directory.populated":"view.instance.files.disallowed.directory.delete"}))},l.createElement(r.Z,{variant:"danger",disabled:!h||e.children.length>0,onClick:()=>{confirm(this.props.intl.formatMessage({id:"view.instance.files.delete.directory.confirm"},{directoryName:i}))&&this.shortAsyncAction((()=>this.deleteDirectory(e)))},className:"nowrap"},l.createElement(n.G,{icon:s.NBC}),"\xa0",l.createElement(d.Z,{id:"view.instance.files.delete.directory"})))):null):null))}renderCreate(){const e={entityName:{type:g.fS.String,name:"fields.instance.files.create.name",tooltip:"fields.instance.files.create.name.tip",defaultValue:""},isDirectory:{type:g.fS.Boolean,name:"fields.instance.files.create.directory",defaultValue:!1}},t=this.state.selectedCreateNode;return l.createElement(l.Fragment,null,l.createElement("h5",null,t.fileResponse.path,t.parent?"/":""),l.createElement("h5",null,l.createElement(d.Z,{id:"view.instance.files.create"})),l.createElement("hr",null),l.createElement(v.Z,{fields:e,onSave:e=>{this.createEntity(e,t)},saveMessageId:"fields.instance.files.create"}))}renderSelectedFile(){const e=(0,u.H5)(this.context.instancePermissionSet,m.TI.Read),t=(0,u.H5)(this.context.instancePermissionSet,m.TI.Write),i=this.state.selectedFile,s=Math.max(i.fileResponse.path.lastIndexOf("\\"),i.fileResponse.path.lastIndexOf("/")),n=i.fileResponse.path.slice(s+1),a=!i.fileResponse.lastReadHash;return l.createElement(l.Fragment,null,l.createElement("h5",null,"/",i.fileResponse.path),l.createElement("hr",null),l.createElement("div",{className:"mb-3"},l.createElement(o.Z,{placement:"top",overlay:e=>l.createElement(c.Z,b({id:"file-download-location-tooltip"},e),l.createElement(d.Z,{id:"view.instance.files.download.location"}))},l.createElement(r.Z,{className:"mx-2",disabled:!e,onClick:()=>{this.downloadFile()}},l.createElement(d.Z,{id:"view.instance.files.download"}))),l.createElement(o.Z,{placement:"top",show:!(!t||!a)&&void 0,overlay:e=>l.createElement(c.Z,b({id:"file-not-refreshed-tooltip"},e),l.createElement(d.Z,{id:"view.instance.files.replace.stale"}))},l.createElement(r.Z,{variant:"warning",className:"mx-2",disabled:!t||a,onClick:()=>{this.createEntity({entityName:n,isDirectory:!1,replace:!0},i)}},l.createElement(d.Z,{id:"view.instance.files.replace"}))),l.createElement(o.Z,{placement:"top",show:!(!t||!a)&&void 0,overlay:e=>l.createElement(c.Z,b({id:"file-not-refreshed-tooltip-delete"},e),l.createElement(d.Z,{id:"view.instance.files.replace.stale"}))},l.createElement(r.Z,{variant:"danger",className:"mx-2",disabled:!t||a,onClick:()=>{confirm(this.props.intl.formatMessage({id:"view.instance.files.delete.confirm"},{path:i.fileResponse.path}))&&this.shortAsyncAction((()=>this.deleteFile()))}},l.createElement(d.Z,{id:"view.instance.files.delete"})))))}renderBrowserlessForms(){return l.createElement(Z.Z,null)}}S.contextType=y.g,t.default=(0,h.ZP)(S)}}]);
//# sourceMappingURL=926.189cdeb0dc471ec325eb.bundle.js.map