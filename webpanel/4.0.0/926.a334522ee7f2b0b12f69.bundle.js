"use strict";(self.webpackChunktgstation_server_control_panel=self.webpackChunktgstation_server_control_panel||[]).push([[926],{6642:function(e,t,i){i.d(t,{Z:function(){return r}});var s=i(7294),n=i(5881),a=i(4012),l=i(6755);class r extends s.Component{render(){return s.createElement(n.Z,{className:"bg-transparent",border:"info"},s.createElement(n.Z.Header,{className:"bg-info text-dark font-weight-bold"},s.createElement(a.Z,{id:"generic.wip"})),s.createElement(n.Z.Body,null,s.createElement(n.Z.Title,null,s.createElement(a.Z,{id:"generic.wip.desc"}),s.createElement("a",{href:"https://github.com/tgstation/Tgstation.Server.ControlPanel/releases/latest"},"https://github.com/tgstation/Tgstation.Server.ControlPanel/releases/latest")),s.createElement(n.Z.Text,{as:"pre",className:"bg-transparent text-info"},s.createElement("code",null,`Version: ${l.q4}\nWebpanel Mode: ${l.IK}\nCurrent route: ${window.location.toString()}`))))}}},926:function(e,t,i){i.r(t);var s=i(1436),n=i(7814),a=i(7294),l=i(5005),r=i(5293),c=i(3489),o=i(4012),d=i(4806),h=i(3637),m=i(8509),p=i(3803),f=i(6190),y=i(6964),u=i(3e3),E=i(9635),w=i(9049),g=i(5619),v=i(8425),x=i(5855),Z=i(6642);function R(){return R=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(e[s]=i[s])}return e},R.apply(this,arguments)}class b{constructor(e,t){this.parent=void 0,this.children=void 0,this.fileResponse=void 0,this.totalFiles=void 0,this.fullyLoaded=!1,this.fileResponse=e,this.parent=t??null,e.isDirectory||(this.fullyLoaded=!0),this.children=[]}}class F extends a.Component{constructor(e){super(e),this.state={errors:[],rootDirectory:null,loading:!0,selectedFile:null,selectedCreateNode:null},this.createEntity=this.createEntity.bind(this),this.selectFile=this.selectFile.bind(this),this.shortAsyncAction=this.shortAsyncAction.bind(this),this.deleteFile=this.deleteFile.bind(this),this.loadDirectory=this.loadDirectory.bind(this),this.clearDirectory=this.clearDirectory.bind(this)}addError(e){this.setState((t=>{const i=Array.from(t.errors);return i.push(e),{errors:i}}))}async componentDidMount(){await this.loadRootDir()}async loadRootDir(){if((0,y.H5)(this.context.instancePermissionSet,m.TI.List)){this.setState({loading:!0});const e=new b({path:"/",isDirectory:!0,fileTicket:""});await this.loadDirectory(e),this.setState({rootDirectory:e,loading:!1})}else this.setState({loading:!1})}async shortAsyncAction(e){const t=e();let i=!1;const s=new Promise((e=>setTimeout(e,750))).then((()=>{i=!0}));await Promise.race([t,s]),i?(this.setState({loading:!0}),await t,this.setState({loading:!1})):this.forceUpdate()}async deleteDirectory(e){const t=await h.Z.deleteDirectory(this.context.instance.id,{path:e.fileResponse.path});if(t.code===p.G.OK){if(null!=e.parent){const t=e.parent.children.indexOf(e);e.parent.children.splice(t,1),this.forceUpdate()}}else this.addError(t.error)}async loadDirectory(e){if((0,y.H5)(this.context.instancePermissionSet,m.TI.List)){this.clearDirectory(e);const t="\\"===e.fileResponse.path[0]||"/"===e.fileResponse.path[0]?e.fileResponse.path.slice(1):e.fileResponse.path;let i=1;for(let s=1;s<=i;++s){const n=await h.Z.getDirectory(this.context.instance.id,t,{page:s});if(n.code!==p.G.OK){this.addError(n.error);break}{i=n.payload.totalPages,i<=s&&(e.fullyLoaded=!0);const t=n.payload.content.map((t=>new b(t,e)));for(const i of t)e.children.push(i)}}e.children=e.children.sort().reverse().sort(((e,t)=>t.fileResponse.isDirectory?1:0))}}async selectFile(e){if(this.state.selectedFile===e)return void this.setState({selectedFile:null});let t=e.fileResponse.path;for(;t.startsWith("/");)t=t.substring(1);const i=await h.Z.getConfigFile(this.context.instance.id,t,!1);i.code===p.G.OK?e.fileResponse=i.payload:(this.addError(i.error),e.fileResponse.lastReadHash=null),this.setState({selectedFile:e,selectedCreateNode:null})}async deleteFile(){const e=this.state.selectedFile,t=await h.Z.writeConfigFile(this.context.instance.id,{path:e.fileResponse.path,lastReadHash:e.fileResponse.lastReadHash},new Uint8Array);if(t.code===p.G.OK){const t=e.parent,i=t.children.indexOf(e);t.children.splice(i,1),this.setState({selectedFile:null})}else this.addError(t.error)}async downloadFile(){this.setState({loading:!0});const e=this.state.selectedFile,t=await h.Z.getConfigFile(this.context.instance.id,e.fileResponse.path,!0);if(t.code===p.G.OK){const i=Math.max(e.fileResponse.path.lastIndexOf("\\"),e.fileResponse.path.lastIndexOf("/"));((e,t)=>{const i=window.navigator;if(i&&i.msSaveOrOpenBlob)i.msSaveOrOpenBlob(t,e);else{const i=document.createElement("a");document.body.appendChild(i);const s=URL.createObjectURL(t);i.href=s,i.download=e,i.click(),URL.revokeObjectURL(i.href),i.remove()}})(e.fileResponse.path.slice(i+1),t.payload.content)}else this.addError(t.error);this.setState({loading:!1})}async createEntity(e,t){let i;if(e.isDirectory)i=new Uint8Array;else{const e=new Promise((e=>{const t=document.createElement("input");t.type="file",t.onchange=t=>{const i=t.target?.files;e(i?i[0]:null)},t.click()})),t=await e;if(!t)return;i=await t.arrayBuffer()}this.setState({loading:!0});let s=t.fileResponse.path;e.replace?s="/"+s:s+="/"+e.entityName,s.startsWith("//")&&(s=s.substring(1)),e.isDirectory&&(s+="/webpanel.dir.create.tmp");const n=await h.Z.writeConfigFile(this.context.instance.id,{path:s,lastReadHash:e.replace?t.fileResponse.lastReadHash:null},i);n.code!==p.G.OK?this.addError(n.error):e.replace&&(t.fileResponse=n.payload),e.replace||(t.fullyLoaded=!1,await this.loadDirectory(t));let a=s.replace("\\","/");a.startsWith("/")&&(a=a.substring(1));const l=t.children.find((e=>a.startsWith(e.fileResponse.path.replace("\\","/"))))??null;l&&(e.isDirectory?(await this.loadDirectory(l),this.setState({selectedCreateNode:null,selectedFile:null})):await this.selectFile(l)),this.setState({loading:!1})}clearDirectory(e){e.fullyLoaded=!1,e.children.forEach((e=>{e===this.state.selectedFile?this.setState({selectedFile:null}):e===this.state.selectedCreateNode&&this.setState({selectedCreateNode:null}),e.fileResponse.isDirectory&&this.clearDirectory(e)})),e.children=[]}render(){if(this.state.loading)return a.createElement(x.Z,{text:"loading.instance.files"});if(this.context.instance.configurationType===m.c7.Disallowed)return a.createElement("div",{className:"text-center"},a.createElement(E.Z,{title:"view.instance.files.disallowed"}));const e=(0,y.H5)(this.context.instancePermissionSet,m.TI.List),t=(0,y.H5)(this.context.instancePermissionSet,m.TI.Write);return a.createElement("div",null,a.createElement(v.t,{obj:this.state}),a.createElement("h2",{className:"text-center"},a.createElement(o.Z,{id:"view.instance.files.file_browser"})),this.state.errors.map(((e,t)=>{if(e)return a.createElement(u.ZP,{key:t,error:e,onClose:()=>this.setState((e=>{const i=Array.from(e.errors);return i[t]=void 0,{errors:i}}))})})),a.createElement("div",{className:"d-flex flex-row"},e?a.createElement("div",{className:"text-left",style:{paddingRight:"16px",maxHeight:"800px",minWidth:"200px",overflowY:"scroll"}},a.createElement("ul",{className:"browser-ul"},this.renderDirectory(this.state.rootDirectory))):a.createElement("div",{style:{maxWidth:"200px"}},a.createElement(E.Z,{title:"view.instance.files.disallowed.directory"})),a.createElement("div",{className:"flex-fill flex-column text-center align-self-center",style:{padding:"16px"}},t?a.createElement(a.Fragment,null):a.createElement(E.Z,{title:"view.instance.files.disallowed.write"}),this.state.selectedCreateNode?this.renderCreate():this.state.selectedFile?this.renderSelectedFile():e?a.createElement("h4",null,a.createElement(o.Z,{id:"view.instance.files.select_item"})):this.renderBrowserlessForms())))}renderDirectory(e){const t=Math.max(e.fileResponse.path.lastIndexOf("\\"),e.fileResponse.path.lastIndexOf("/"));if(!e.fileResponse.isDirectory){const i=e===this.state.selectedFile,r=e.fileResponse.path.slice(t+1);return a.createElement("li",{className:"browser-li"},a.createElement(l.Z,{variant:i?"secondary":"primary",onClick:()=>{this.shortAsyncAction((()=>this.selectFile(e)))},className:"nowrap"},a.createElement(n.G,{icon:s.cwv}),"\xa0",r))}const i=e==this.state.rootDirectory?"Configuration":e.fileResponse.path.slice(t+1),d=this.state.selectedCreateNode===e,h=(0,y.H5)(this.context.instancePermissionSet,m.TI.Delete);return a.createElement(a.Fragment,null,a.createElement("li",{className:"browser-li"},e.fullyLoaded?a.createElement(l.Z,{className:"nowrap",variant:"secondary",onClick:()=>{this.clearDirectory(e),this.forceUpdate()}},a.createElement(n.G,{icon:s.Jvx}),"\xa0",i):a.createElement(l.Z,{className:"nowrap",onClick:()=>{this.shortAsyncAction((()=>this.loadDirectory(e)))}},a.createElement(n.G,{icon:s.x58}),"\xa0",i)),a.createElement("ul",{className:"browser-ul"},e.children.map((e=>a.createElement(a.Fragment,{key:e.fileResponse.path},this.renderDirectory(e)))),e.fullyLoaded?a.createElement(a.Fragment,null,a.createElement("li",{className:"browser-li"},a.createElement(l.Z,{variant:d?"secondary":"primary",onClick:()=>{this.state.selectedCreateNode!=e&&this.setState({selectedCreateNode:e})},className:"nowrap"},a.createElement(n.G,{icon:s.gMD}),"\xa0(",a.createElement(o.Z,{id:"view.instance.files.create"}),")")),e.parent?a.createElement("li",{className:"browser-li"},a.createElement(r.Z,{placement:"top",show:(!h||0!==e.children.length)&&void 0,overlay:e=>a.createElement(c.Z,R({id:"cant-delete-dir-tooltip"},e),a.createElement(o.Z,{id:h?"view.instance.files.delete.directory.populated":"view.instance.files.disallowed.directory.delete"}))},a.createElement(l.Z,{variant:"danger",disabled:!h||e.children.length>0,onClick:()=>{confirm(this.props.intl.formatMessage({id:"view.instance.files.delete.directory.confirm"},{directoryName:i}))&&this.shortAsyncAction((()=>this.deleteDirectory(e)))},className:"nowrap"},a.createElement(n.G,{icon:s.NBC}),"\xa0",a.createElement(o.Z,{id:"view.instance.files.delete.directory"})))):a.createElement(a.Fragment,null)):a.createElement(a.Fragment,null)))}renderCreate(){const e={entityName:{type:w.fS.String,name:"fields.instance.files.create.name",tooltip:"fields.instance.files.create.name.tip",defaultValue:""},isDirectory:{type:w.fS.Boolean,name:"fields.instance.files.create.directory",defaultValue:!1}},t=this.state.selectedCreateNode;return a.createElement(a.Fragment,null,a.createElement("h5",null,t.fileResponse.path,t.parent?"/":""),a.createElement("h5",null,a.createElement(o.Z,{id:"view.instance.files.create"})),a.createElement("hr",null),a.createElement(g.Z,{fields:e,onSave:e=>{this.createEntity(e,t)},saveMessageId:"fields.instance.files.create"}))}renderSelectedFile(){const e=(0,y.H5)(this.context.instancePermissionSet,m.TI.Read),t=(0,y.H5)(this.context.instancePermissionSet,m.TI.Write),i=this.state.selectedFile,s=Math.max(i.fileResponse.path.lastIndexOf("\\"),i.fileResponse.path.lastIndexOf("/")),n=i.fileResponse.path.slice(s+1),d=!i.fileResponse.lastReadHash;return a.createElement(a.Fragment,null,a.createElement("h5",null,"/",i.fileResponse.path),a.createElement("hr",null),a.createElement("div",{className:"mb-3"},a.createElement(r.Z,{placement:"top",overlay:e=>a.createElement(c.Z,R({id:"file-download-location-tooltip"},e),a.createElement(o.Z,{id:"view.instance.files.download.location"}))},a.createElement(l.Z,{className:"mx-2",disabled:!e,onClick:()=>{this.downloadFile()}},a.createElement(o.Z,{id:"view.instance.files.download"}))),a.createElement(r.Z,{placement:"top",show:!(!t||!d)&&void 0,overlay:e=>a.createElement(c.Z,R({id:"file-not-refreshed-tooltip"},e),a.createElement(o.Z,{id:"view.instance.files.replace.stale"}))},a.createElement(l.Z,{variant:"warning",className:"mx-2",disabled:!t||d,onClick:()=>{this.createEntity({entityName:n,isDirectory:!1,replace:!0},i)}},a.createElement(o.Z,{id:"view.instance.files.replace"}))),a.createElement(r.Z,{placement:"top",show:!(!t||!d)&&void 0,overlay:e=>a.createElement(c.Z,R({id:"file-not-refreshed-tooltip-delete"},e),a.createElement(o.Z,{id:"view.instance.files.replace.stale"}))},a.createElement(l.Z,{variant:"danger",className:"mx-2",disabled:!t||d,onClick:()=>{confirm(this.props.intl.formatMessage({id:"view.instance.files.delete.confirm"},{path:i.fileResponse.path}))&&this.shortAsyncAction((()=>this.deleteFile()))}},a.createElement(o.Z,{id:"view.instance.files.delete"})))))}renderBrowserlessForms(){return a.createElement(Z.Z,null)}}F.contextType=f.g,t.default=(0,d.ZP)(F)}}]);
//# sourceMappingURL=926.a334522ee7f2b0b12f69.bundle.js.map