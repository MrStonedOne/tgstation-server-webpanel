"use strict";(self.webpackChunktgstation_server_control_panel=self.webpackChunktgstation_server_control_panel||[]).push([[345],{7345:function(e,t,n){n.r(t);var s=n(7814),r=n(7294),i=n(8375),a=n(5509),o=n(6841),c=n(1555),m=n(2318),l=n(2258),d=n(5005),u=n(5293),h=n(3489),p=n(4012),E=n(5977),g=n(8509),f=n(6352),P=n(5870),v=n(6846),Z=n(3803),y=n(6942),S=n(4803),b=n(6190),x=n(6964),C=n(1320),O=n(3e3),w=n(9049),I=n(8425),K=n(5855);function k(){return k=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},k.apply(this,arguments)}class R extends r.Component{constructor(e){super(e),this.loadCurrentPermissions=this.loadCurrentPermissions.bind(this),this.createPermissionSetForCurrent=this.createPermissionSetForCurrent.bind(this),this.grantPermissions=this.grantPermissions.bind(this),this.state={errors:[],loading:!0,loadingPerms:!0,instanceNeedsReload:!1,tab:"instancepermissionsetperms",userPermissions:{permissionSetId:0,instancePermissionSetRights:0,repositoryRights:0,byondRights:0,dreamMakerRights:0,dreamDaemonRights:0,chatBotRights:0,configurationRights:0},currentPermissions:null,selectedPermissionSetId:0,permsinstancepermissionset:{},permsrepository:{},permsbyond:{},permsdreammaker:{},permsdreamdaemon:{},permschatbots:{},permsconfiguration:{}}}loadEnums(e){this.setState({currentPermissions:e});const t=(t,n,s)=>{Object.entries(t).forEach((([t,r])=>{if(!isNaN(parseInt(t)))return;const i=t.toLowerCase(),a=r;if("none"==i)return;const o=!!(e[n]&a);this.setState((e=>({[s]:{...e[s],[i]:{currentVal:o,bitflag:a}}})))}))};t(g.d$,"instancePermissionSetRights","permsinstancepermissionset"),t(g.nX,"repositoryRights","permsrepository"),t(g.D8,"byondRights","permsbyond"),t(g.xb,"dreamMakerRights","permsdreammaker"),t(g.py,"dreamDaemonRights","permsdreamdaemon"),t(g.xr,"chatBotRights","permschatbots"),t(g.TI,"configurationRights","permsconfiguration")}addError(e){this.setState((t=>{const n=Array.from(t.errors);return n.push(e),{errors:n}}))}async loadCurrentPermissions(e){if(this.setState({loadingPerms:!0}),e===(0,x.Zg)(this.context.user).id){const e=new Promise((e=>setTimeout(e,200))),t=await P.Z.getCurrentInstancePermissionSet(this.context.instance.id,!0);await e,t.code===Z.G.OK?(this.setState({userPermissions:t.payload}),this.loadEnums(t.payload)):this.addError(t.error)}else if((0,x.JY)(this.context.instancePermissionSet,g.d$.Read)){const t=await P.Z.getByPermissionSetId(this.context.instance.id,e);t.code===Z.G.OK?this.loadEnums(t.payload):t.error.code==v.jK.NO_DB_ENTITY?this.setState({currentPermissions:null}):this.addError(t.error)}this.setState({loadingPerms:!1})}async loadUsersAndGroups(){const e=(0,x.Zg)(this.context.user);if(!(0,x.N3)(e,g.oj.ReadUsers))return void this.setState({groups:null,users:null});let t=!1;const n=y.Z.listUsers({page:1,pageSize:100}),s=await S.Z.listGroups({page:1,pageSize:100});t=!0,s.code===Z.G.OK?this.setState({groups:s.payload.content}):(this.addError(s.error),t=!1);const r=await n;r.code===Z.G.OK?this.setState({users:r.payload.content.filter((e=>!e.group))}):(this.addError(r.error),t=!1),t||(this.context.user.group?this.setState({groups:[this.context.user.group],users:[]}):this.setState({groups:[],users:[this.context.user]}))}async loadAllPermissionSets(){let e=!1;if((0,x.JY)(this.context.instancePermissionSet,g.d$.Read)){const t=await P.Z.listInstancePermissionSets(this.context.instance.id,{page:1,pageSize:100});t.code===Z.G.OK?(this.setState({instancePermissionSets:t.payload.content}),e=!0):this.addError(t.error)}e||this.setState({instancePermissionSets:[this.context.instancePermissionSet]})}async createPermissionSetForCurrent(){const e=await P.Z.createInstancePermissionSet(this.context.instance.id,{permissionSetId:this.state.selectedPermissionSetId});e.code!=Z.G.OK?this.addError(e.error):this.setState({currentPermissions:e.payload})}async grantPermissions(){const e=await f.Z.grantPermissions({id:this.context.instance.id});e.code!=Z.G.OK?this.addError(e.error):await this.loadCurrentPermissions(this.state.selectedPermissionSetId)}async deletePermissionSet(){if(!confirm("Are you sure you want to delete this permission set? The selected user/group will lose access to the instance."))return;const e=await P.Z.deleteInstancePermissionSet(this.context.instance.id,this.state.selectedPermissionSetId);e.code!=Z.G.OK&&e.error.code!=v.jK.NO_DB_ENTITY?this.addError(e.error):this.state.selectedPermissionSetId===(0,x.Zg)(this.context.user).id?(C.Mq.selectedinstanceid=void 0,this.props.history.push(C.$w.instancelist.link??C.$w.instancelist.route)):this.setState({currentPermissions:null})}async componentDidMount(){const e=(0,x.Zg)(this.context.user).id;this.setState({selectedPermissionSetId:e,userPermissions:this.context.instancePermissionSet});const t=this.loadCurrentPermissions(e),n=this.loadAllPermissionSets();await this.loadUsersAndGroups(),await t,await n,this.setState({loading:!1})}async componentWillUnmount(){this.state.instanceNeedsReload&&await this.context.reloadInstance()}render(){if(this.state.loading)return r.createElement(K.Z,{text:"loading.instance"});const e=new Map,t={};if(this.state.users&&this.state.groups)this.state.users?.forEach((n=>{const s=`User: ${n.name}${n.id===this.context.user.id?" (You)":""}`;e.set(s,n.permissionSet.id),t[s]=n.permissionSet.id})),this.state.groups?.forEach((n=>{const s=`Group: ${n.name}${n.id===this.context.user.group?.id?" (Your Group)":""}`;e.set(s,n.permissionSet.id),t[s]=n.permissionSet.id}));else{if(this.context.user.group){const n=`Group: ${this.context.user.group.name} (Your Group)`;e.set(n,this.context.user.group.permissionSet.id),t[n]=this.context.user.group.permissionSet.id}else{const n=`User: ${this.context.user.name} (You)`;e.set(n,this.context.user.permissionSet.id),t[n]=this.context.user.permissionSet.id}this.state.instancePermissionSets?.forEach((n=>{if(n.permissionSetId===(0,x.Zg)(this.context.user).id)return;const s=`Permission Set ${n.permissionSetId}`;e.set(s,n.permissionSetId),t[s]=n.permissionSetId}))}return r.createElement("div",{className:"text-center"},r.createElement("h1",null,r.createElement(p.Z,{id:"view.instance.perms"})),r.createElement(I.t,{obj:this.state}),this.state.errors.map(((e,t)=>{if(e)return r.createElement(O.ZP,{key:t,error:e,onClose:()=>this.setState((e=>{const n=Array.from(e.errors);return n[t]=void 0,{errors:n}}))})})),r.createElement(w.ZP,{name:"fields.instance.perms.owner",type:w.fS.Enum,enum:t,noLocalize:!0,defaultValue:this.state.selectedPermissionSetId,disabled:this.context.instancePermissionSet.instancePermissionSetRights===g.d$.None,onChange:e=>{this.setState({selectedPermissionSetId:e}),this.loadCurrentPermissions(e)}}),r.createElement("hr",null),this.renderPermissionEditor())}renderPermissionEditor(){if(this.state.loadingPerms)return r.createElement(K.Z,{text:"loading.perms"});let e=!1,t=r.createElement(r.Fragment,null);const n=(0,x.Zg)(this.context.user);if(n.id!==this.state.selectedPermissionSetId||!(0,x.D0)(n,g.c2.GrantPermissions)||this.state.currentPermissions&&(0,x.JY)(this.state.currentPermissions,g.d$.Write)||(e=!0,t=r.createElement(r.Fragment,null,r.createElement("hr",null),r.createElement("h5",null,r.createElement(p.Z,{id:"view.instance.perms.grant.desc"})),r.createElement(d.Z,{variant:"success",onClick:()=>{this.grantPermissions()}},r.createElement(p.Z,{id:"view.instance.perms.grant"})))),!this.state.currentPermissions){const t=(0,x.JY)(this.state.userPermissions,g.d$.Create);return r.createElement("div",{className:"text-center mt-2"},r.createElement("h3",null,r.createElement(p.Z,{id:"view.instance.perms.missing"})),e?r.createElement(r.Fragment,null):r.createElement(r.Fragment,null,r.createElement("br",null),r.createElement(u.Z,{placement:"top",overlay:e=>r.createElement(h.Z,k({id:"create-ips-tooltop"},e),r.createElement(p.Z,{id:"view.instance.perms.create"}))},r.createElement(d.Z,{variant:"success",disabled:!t,onClick:()=>{this.createPermissionSetForCurrent()}},r.createElement(p.Z,{id:"view.instance.perms.create"})))))}return r.createElement(r.Fragment,null,this.renderEditorTabs(),t)}renderEditorTabs(){const e=(0,x.JY)(this.state.userPermissions,g.d$.Write);return r.createElement(r.Fragment,null,e?r.createElement(r.Fragment,null):r.createElement(i.Z,{className:"clearfix",variant:"error"},r.createElement(p.Z,{id:"perms.instancepermissionset.cantedit"})),r.createElement(a.Z,{activeKey:this.state.tab,onSelect:e=>{e&&this.setState({tab:e})},id:"permission-tabs",className:"justify-content-center mb-3 mt-4 flex-column flex-md-row"},r.createElement(o.Z,{eventKey:"instancepermissionsetperms",title:r.createElement(p.Z,{id:"perms.instancepermissionset"})},this.renderPerms("permsinstancepermissionset","instancepermissionset",e)),r.createElement(o.Z,{eventKey:"repositoryperms",title:r.createElement(p.Z,{id:"perms.repository"})},this.renderPerms("permsrepository","repository",e)),r.createElement(o.Z,{eventKey:"byondperms",title:r.createElement(p.Z,{id:"perms.byond"})},this.renderPerms("permsbyond","byond",e)),r.createElement(o.Z,{eventKey:"dreammakerperms",title:r.createElement(p.Z,{id:"perms.dreammaker"})},this.renderPerms("permsdreammaker","dreammaker",e)),r.createElement(o.Z,{eventKey:"dreamdaemonperms",title:r.createElement(p.Z,{id:"perms.dreamdaemon"})},this.renderPerms("permsdreamdaemon","dreamdaemon",e)),r.createElement(o.Z,{eventKey:"chatbotsperms",title:r.createElement(p.Z,{id:"perms.chatbots"})},this.renderPerms("permschatbots","chatbots",e)),r.createElement(o.Z,{eventKey:"configurationperms",title:r.createElement(p.Z,{id:"perms.configuration"})},this.renderPerms("permsconfiguration","configuration",e))),"instancepermissionsetperms"===this.state.tab?r.createElement(r.Fragment,null,r.createElement("br",null),r.createElement(d.Z,{variant:"danger",onClick:()=>{this.deletePermissionSet()}},r.createElement(p.Z,{id:"view.instance.perms.delete"}))):r.createElement(r.Fragment,null))}renderPerms(e,t,n){const i={},a=(e,t,n)=>{e.current&&t.current&&(e.current.checked!==n?t.current.classList.add("font-weight-bold"):t.current.classList.remove("font-weight-bold"))},o=t=>()=>{for(const[n,s]of Object.entries(i)){if(!s.input.current)return;s.input.current.checked=t,a(s.input,s.field,this.state[e][n].currentVal)}};return r.createElement(r.Fragment,null,n?r.createElement(r.Fragment,null,r.createElement("h5",null,r.createElement(p.Z,{id:"generic.setall"})),r.createElement(d.Z,{onClick:o(!0)},r.createElement(p.Z,{id:"generic.true"}))," ",r.createElement(d.Z,{onClick:o(!1)},r.createElement(p.Z,{id:"generic.false"}))," ",r.createElement(d.Z,{onClick:()=>{for(const[t,n]of Object.entries(i))n.input.current&&(n.input.current.checked=this.state[e][t].currentVal,a(n.input,n.field,this.state[e][t].currentVal))}},r.createElement(p.Z,{id:"generic.reset"}))):"",r.createElement(c.Z,{md:8,lg:7,xl:6,className:"mx-auto"},r.createElement("hr",null),Object.entries(this.state[e]).map((([e,o])=>{const c=r.createRef(),d=r.createRef();return i[e]={input:c,field:d},r.createElement(m.Z,{key:e,as:"label",htmlFor:e,className:"mb-0"},r.createElement(m.Z.Prepend,{className:"flex-grow-1 overflow-auto"},r.createElement(u.Z,{overlay:r.createElement(h.Z,{id:`perms.${t}.${e}.desc`},r.createElement(p.Z,{id:`perms.${t}.${e}.desc`}))},(({ref:i,...u})=>r.createElement(m.Z.Text,{className:"flex-fill",ref:d},r.createElement("div",u,r.createElement(p.Z,{id:`perms.${t}.${e}`})),r.createElement("div",{className:"ml-auto d-flex align-items-center"},r.createElement(l.Z.Check,{inline:!0,type:"switch",custom:!0,id:e,className:"d-flex justify-content-center align-content-center mx-2",label:"",ref:c,disabled:!n,defaultChecked:o.currentVal,onChange:()=>{a(c,d,o.currentVal)}}),r.createElement("div",k({},u,{ref:i}),r.createElement(s.G,{fixedWidth:!0,icon:"info"}))))))))})),r.createElement("hr",null)),n?r.createElement(d.Z,{onClick:async()=>{this.setState({loadingPerms:!0});let t,n=0;for(const[t,s]of Object.entries(i))s.input.current&&(n+=s.input.current.checked?this.state[e][t].bitflag:0);if(!this.state.currentPermissions)return void this.addError(new v.ZP(v.jK.APP_FAIL,{jsError:Error("this.state.user is null in user edit save")}));switch(e){case"permsinstancepermissionset":t="InstancePermissionSetRights";break;case"permsrepository":t="RepositoryRights";break;case"permsbyond":t="ByondRights";break;case"permsdreammaker":t="DreamMakerRights";break;case"permsdreamdaemon":t="DreamDaemonRights";break;case"permschatbots":t="ChatBotRights";break;case"permsconfiguration":t="ConfigurationRights"}const s=Object.assign(Object.assign({},this.state.currentPermissions),{[t]:n}),r=await P.Z.updateInstancePermissionSet(this.context.instance.id,s);r.code==Z.G.OK?(s.permissionSetId===this.state.userPermissions?.permissionSetId&&this.setState({userPermissions:r.payload,instanceNeedsReload:!0}),this.loadEnums(r.payload)):this.addError(r.error),this.setState({loadingPerms:!1})}},r.createElement(p.Z,{id:"generic.savepage"})):"")}}R.contextType=b.g,t.default=(0,E.EN)(R)},6841:function(e,t,n){var s=n(1721),r=n(7294),i=n(7184),a=n(8752),o=n(5103),c=function(e){function t(){return e.apply(this,arguments)||this}return(0,s.Z)(t,e),t.prototype.render=function(){throw new Error("ReactBootstrap: The `Tab` component is not meant to be rendered! It's an abstract component that is only valid as a direct Child of the `Tabs` Component. For custom tabs components use TabPane and TabsContainer directly")},t}(r.Component);c.Container=i.Z,c.Content=a.Z,c.Pane=o.Z,t.Z=c},7184:function(e,t,n){var s=n(7294),r=n(4289),i=n(4426),a=n(5017);t.Z=function(e){var t=(0,r.Ch)(e,{activeKey:"onSelect"}),n=t.id,o=t.generateChildId,c=t.onSelect,m=t.activeKey,l=t.transition,d=t.mountOnEnter,u=t.unmountOnExit,h=t.children,p=(0,s.useMemo)((function(){return o||function(e,t){return n?n+"-"+t+"-"+e:null}}),[n,o]),E=(0,s.useMemo)((function(){return{onSelect:c,activeKey:m,transition:l,mountOnEnter:d||!1,unmountOnExit:u||!1,getControlledId:function(e){return p(e,"tabpane")},getControllerId:function(e){return p(e,"tab")}}}),[c,m,l,d,u,p]);return s.createElement(i.Z.Provider,{value:E},s.createElement(a.Z.Provider,{value:c||null},h))}},8752:function(e,t,n){var s=n(7462),r=n(3366),i=n(4184),a=n.n(i),o=n(7294),c=n(6792),m=["bsPrefix","as","className"],l=o.forwardRef((function(e,t){var n=e.bsPrefix,i=e.as,l=void 0===i?"div":i,d=e.className,u=(0,r.Z)(e,m),h=(0,c.vE)(n,"tab-content");return o.createElement(l,(0,s.Z)({ref:t},u,{className:a()(d,h)}))}));t.Z=l},5103:function(e,t,n){var s=n(7462),r=n(3366),i=n(4184),a=n.n(i),o=n(7294),c=n(6792),m=n(4426),l=n(5017),d=n(9280),u=["activeKey","getControlledId","getControllerId"],h=["bsPrefix","className","active","onEnter","onEntering","onEntered","onExit","onExiting","onExited","mountOnEnter","unmountOnExit","transition","as","eventKey"];var p=o.forwardRef((function(e,t){var n=function(e){var t=(0,o.useContext)(m.Z);if(!t)return e;var n=t.activeKey,i=t.getControlledId,a=t.getControllerId,c=(0,r.Z)(t,u),h=!1!==e.transition&&!1!==c.transition,p=(0,l.h)(e.eventKey);return(0,s.Z)({},e,{active:null==e.active&&null!=p?(0,l.h)(n)===p:e.active,id:i(e.eventKey),"aria-labelledby":a(e.eventKey),transition:h&&(e.transition||c.transition||d.Z),mountOnEnter:null!=e.mountOnEnter?e.mountOnEnter:c.mountOnEnter,unmountOnExit:null!=e.unmountOnExit?e.unmountOnExit:c.unmountOnExit})}(e),i=n.bsPrefix,p=n.className,E=n.active,g=n.onEnter,f=n.onEntering,P=n.onEntered,v=n.onExit,Z=n.onExiting,y=n.onExited,S=n.mountOnEnter,b=n.unmountOnExit,x=n.transition,C=n.as,O=void 0===C?"div":C,w=(n.eventKey,(0,r.Z)(n,h)),I=(0,c.vE)(i,"tab-pane");if(!E&&!x&&b)return null;var K=o.createElement(O,(0,s.Z)({},w,{ref:t,role:"tabpanel","aria-hidden":!E,className:a()(p,I,{active:E})}));return x&&(K=o.createElement(x,{in:E,onEnter:g,onEntering:f,onEntered:P,onExit:v,onExiting:Z,onExited:y,mountOnEnter:S,unmountOnExit:b},K)),o.createElement(m.Z.Provider,{value:null},o.createElement(l.Z.Provider,{value:null},K))}));p.displayName="TabPane",t.Z=p},5509:function(e,t,n){var s=n(7462),r=n(3366),i=n(7294),a=(n(5638),n(4289)),o=n(3361),c=n(3982),m=n(1244),l=n(7184),d=n(8752),u=n(5103),h=n(3439),p=["id","onSelect","transition","mountOnEnter","unmountOnExit","children","activeKey"];function E(e){var t=e.props,n=t.title,s=t.eventKey,r=t.disabled,a=t.tabClassName,o=t.id;return null==n?null:i.createElement(m.Z,{as:c.Z,eventKey:s,disabled:r,id:o,className:a},n)}var g=function(e){var t=(0,a.Ch)(e,{activeKey:"onSelect"}),n=t.id,c=t.onSelect,m=t.transition,g=t.mountOnEnter,f=t.unmountOnExit,P=t.children,v=t.activeKey,Z=void 0===v?function(e){var t;return(0,h.E)(e,(function(e){null==t&&(t=e.props.eventKey)})),t}(P):v,y=(0,r.Z)(t,p);return i.createElement(l.Z,{id:n,activeKey:Z,onSelect:c,transition:m,mountOnEnter:g,unmountOnExit:f},i.createElement(o.Z,(0,s.Z)({},y,{role:"tablist",as:"nav"}),(0,h.U)(P,E)),i.createElement(d.Z,null,(0,h.U)(P,(function(e){var t=(0,s.Z)({},e.props);return delete t.title,delete t.disabled,delete t.tabClassName,i.createElement(u.Z,t)}))))};g.defaultProps={variant:"tabs",mountOnEnter:!1,unmountOnExit:!1},g.displayName="Tabs",t.Z=g}}]);
//# sourceMappingURL=345.e39af38577847b0590d8.bundle.js.map